<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Randomized Tesla Lock Sounds using a Pi | k0rventen&#39;s blog</title>
<meta name="keywords" content="raspberrypi, tesla, wav, g_mass_storage, exfat">
<meta name="description" content="A different lock sound every time">
<meta name="author" content="">
<link rel="canonical" href="/posts/tesla-lock-sounds/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="/posts/tesla-lock-sounds/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="/posts/tesla-lock-sounds/">
  <meta property="og:site_name" content="k0rventen&#39;s blog">
  <meta property="og:title" content="Randomized Tesla Lock Sounds using a Pi">
  <meta property="og:description" content="A different lock sound every time">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-24T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-06-24T00:00:00+00:00">
    <meta property="article:tag" content="Raspberrypi">
    <meta property="article:tag" content="Tesla">
    <meta property="article:tag" content="Wav">
    <meta property="article:tag" content="G_mass_storage">
    <meta property="article:tag" content="Exfat">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Randomized Tesla Lock Sounds using a Pi">
<meta name="twitter:description" content="A different lock sound every time">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/posts/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Randomized Tesla Lock Sounds using a Pi",
      "item": "/posts/tesla-lock-sounds/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Randomized Tesla Lock Sounds using a Pi",
  "name": "Randomized Tesla Lock Sounds using a Pi",
  "description": "A different lock sound every time",
  "keywords": [
    "raspberrypi", "tesla", "wav", "g_mass_storage", "exfat"
  ],
  "articleBody": "What and why Since the Winter 2023 Holiday Update, a new feature appeared on my model 3 Highland: you could change the lock sound to some sounds provided by Tesla, or provide your own, by putting a LockChime.wav file at the root of the TESLADRIVE usb key.\nI’ve been playing with it with various sounds found here and there, but I still had to open the glovebox, take the USB key out, change the file and plug it back in.\nI then realized that some raspberry pis (the Zeros W and 2 can, as the 4b)can act as a mass storage device through their usb cable. Wouldn’t that be cool to change the lock sound of the car every time ?\nHow First, let’s flash a Raspberry Pi 4 with a Lite, 64b version of raspberry pi OS.\nThen, we’ll do the following:\nremove unused packages and services to speed up boot time enable the g_mass_storage kernel module (so the Tesla sees a mountable USB partition) create our drive image and script to handle mounting/unmounting test and enjoy ! Once booted, ssh/console into it, and apply the following configuration:\nremove some useless stuff: remove packages\nsudo apt purge triggerhappy avahi-daemon cron modemmanager dphys-swapfile --auto-remove This will remove packages and services that we don’t need, specifically swap, avahi..\ndisable unused services Then disable some services that can affect our boot time, mainly around BLE:\nsudo systemctl disable --now bluetooth.service hciuart.service keyboard-setup.service systemd-timesyncd.service sudo systemctl mask bluetooth.service hciuart.service keyboard-setup.service systemd-timesyncd.service enable the g_mass_storage kernel module Append to the end of /boot/firmware/cmdline.txt:\n... modules-load=dwc2,g_mass_storage This will load the needed kernel modules for the pi to act as a mass storage device\nAt the end of /boot/firmware/config.txt\n[all] dtoverlay=dwc2 boot_delay=0 (You can also comment some stuff in the upper sections, like camera_auto_detect. should make the boot faster, not measured)\nthe actual reason we are doing this Create a big 32Go+ file using fallocate (Sentry Mode will not work if size \u003c 32G)\nsudo fallocate /tesladrive -l 48G Create the main script in /usr/local/bin/tesladrive.sh\n#!/bin/bash # mount as loop mkdir -p /mnt/tesladrive losetup /dev/loop2 /tesladrive mount -t exfat -o offset=1048576,time_offset=-420 /dev/loop2 /mnt/tesladrive # swap the lock chime cp $(find /mnt/tesladrive/chimes/ -maxdepth 1 -type f | shuf -n 1) /mnt/tesladrive/LockChime.wav # unmount umount /mnt/tesladrive losetup -d /dev/loop2 # g_mass_storage modprobe g_mass_storage file=/tesladrive stall=0 The script is fairly simple, it is left as an exercise for the reader (and future me) to figure it out. The only weird thing is the offset argument to the mount command. This is because the device is /dev/loop2, but the exfat partition is actually /dev/loop2p1, which isn’t starting on the same block (thx exfat). So to mount it, you must tell mount how much offset to the actual start of the exfat partition.\nHere is what fdisk returns for our loopdevice:\nDisk /dev/loop2: 48 GiB, 51539607552 bytes, 100663296 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: dos Disk identifier: 0x83f38a18 Device Boot Start End Sectors Size Id Type /dev/loop2p1 2048 100663295 100661248 48G 7 HPFS/NTFS/exFAT So to compute the offset for mount, we do start sector * sector size, in our case 2048*512=1048576\nYour values might be different.\nCreate a service file for it: The goal here is to make is start as early as possible during the boot process, hence the basic target. Put it in /etc/systemd/system/tesladrive.service\n[Unit] Description=Launch the tesla drive module as fast as possible Before=basic.target After=local-fs.target sysinit.target DefaultDependencies=no [Service] ExecStart=/home/coco/tesladrive.sh [Install] WantedBy=basic.target then enable the service:\nsystemctl enable tesladrive create the fs, add your sounds and enjoy ! Now, You can mount manually the partition and format at as exFat:\nlosetup /dev/loop2 /tesladrive mkfs.exfat /dev/loop2 Note: I had an issue where the Tesla did not recognized the partition properly, and I had to format it from the Tesla.\nInside, we’ll create a chimes dir that will hold the available lock sounds. The script will pick one randomly and set it as the default one each time.\nHere is how the file structure should look like:\ncoco@teslapi:~ $ ls /mnt/tesladrive/ LockChime.wav TeslaCam chimes coco@teslapi:~ $ ls /mnt/tesladrive/chimes/ 90s-modem.wav bipbip.wav eternity.wav ogs pikachu.wav airplane-seat-belt.wav canttouchthis.wav hadouken.wav pac-man-die.wav You can find locksounds online, for example here: https://www.notateslaapp.com/tesla-custom-lock-sounds/\nOne thing to note is that the volume can be quite high on some of them. I used sox to reduce it for all of them, as to not be overly loud (but still funny):\nsox -v 0.3 lock.wav lock_low.wav (From https://stackoverflow.com/questions/21776073/reduce-volume-of-audio-file-by-percentage-value-using-sox)\nFinally, plug the Pi in the USB port in the Tesla’s glovebox, select Lock sound: ‘USB’, then step away from the car.\nEvery time the car starts up, this will start the Pi, which will swap the lock sound before mounting the partition as a mass storage for the tesla, changing the lock sound !\n",
  "wordCount" : "814",
  "inLanguage": "en",
  "datePublished": "2024-06-24T00:00:00Z",
  "dateModified": "2024-06-24T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/posts/tesla-lock-sounds/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "k0rventen's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="&gt; k0rventen: ~ (Alt + H)">&gt; k0rventen: ~</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="/links" title="links">
                    <span>links</span>
                </a>
            </li>
            <li>
                <a href="/posts" title="posts">
                    <span>posts</span>
                </a>
            </li>
            <li>
                <a href="/search" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Randomized Tesla Lock Sounds using a Pi
    </h1>
    <div class="post-description">
      A different lock sound every time
    </div>
    <div class="post-meta"><span title='2024-06-24 00:00:00 +0000 UTC'>June 24, 2024</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;814 words

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#remove-some-useless-stuff">remove some useless stuff:</a></li>
    <li><a href="#enable-the-g_mass_storage-kernel-module">enable the g_mass_storage kernel module</a></li>
    <li><a href="#the-actual-reason-we-are-doing-this">the actual reason we are doing this</a></li>
    <li><a href="#create-the-fs-add-your-sounds-and-enjoy-">create the fs, add your sounds and enjoy !</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="what-and-why">What and why<a hidden class="anchor" aria-hidden="true" href="#what-and-why">#</a></h1>
<p>Since the Winter 2023 Holiday Update, a new feature appeared on my model 3 Highland: you could change the lock sound to some sounds provided by Tesla, or provide your own, by putting a <code>LockChime.wav</code> file at the root of the TESLADRIVE usb key.</p>
<p>I&rsquo;ve been playing with it with various sounds found here and there, but I still had to open the glovebox, take the USB key out, change the file and plug it back in.</p>
<p>I then realized that some raspberry pis (the Zeros W and 2 can, as the 4b)can act as a mass storage device through their usb cable. Wouldn&rsquo;t that be cool to change the lock sound of the car every time ?</p>
<h1 id="how">How<a hidden class="anchor" aria-hidden="true" href="#how">#</a></h1>
<p>First, let&rsquo;s flash a Raspberry Pi 4 with a Lite, 64b version of raspberry pi OS.</p>
<p>Then, we&rsquo;ll do the following:</p>
<ul>
<li>remove unused packages and services to speed up boot time</li>
<li>enable the g_mass_storage kernel module (so the Tesla sees a mountable USB partition)</li>
<li>create our drive image and script to handle mounting/unmounting</li>
<li>test and enjoy !</li>
</ul>
<p>Once booted, ssh/console into it, and apply the following configuration:</p>
<h2 id="remove-some-useless-stuff">remove some useless stuff:<a hidden class="anchor" aria-hidden="true" href="#remove-some-useless-stuff">#</a></h2>
<ul>
<li>
<p>remove packages</p>
<pre tabindex="0"><code>sudo apt purge triggerhappy avahi-daemon cron modemmanager dphys-swapfile --auto-remove
</code></pre><p>This will remove packages and services that we don&rsquo;t need, specifically swap, avahi..</p>
</li>
<li>
<p>disable unused services
Then disable some services that can affect our boot time, mainly around BLE:</p>
<pre tabindex="0"><code>sudo systemctl disable --now  bluetooth.service hciuart.service keyboard-setup.service systemd-timesyncd.service
sudo systemctl mask  bluetooth.service hciuart.service keyboard-setup.service systemd-timesyncd.service
</code></pre></li>
</ul>
<h2 id="enable-the-g_mass_storage-kernel-module">enable the g_mass_storage kernel module<a hidden class="anchor" aria-hidden="true" href="#enable-the-g_mass_storage-kernel-module">#</a></h2>
<ul>
<li>
<p>Append to the end of <code>/boot/firmware/cmdline.txt</code>:</p>
<pre tabindex="0"><code>... modules-load=dwc2,g_mass_storage
</code></pre><p>This will load the needed kernel modules for the pi to act as a mass storage device</p>
</li>
<li>
<p>At the end of <code>/boot/firmware/config.txt</code></p>
<pre tabindex="0"><code>[all]
dtoverlay=dwc2
boot_delay=0
</code></pre><p>(You can also comment some stuff in the upper sections, like camera_auto_detect. <em>should</em> make the boot faster, not measured)</p>
</li>
</ul>
<h2 id="the-actual-reason-we-are-doing-this">the actual reason we are doing this<a hidden class="anchor" aria-hidden="true" href="#the-actual-reason-we-are-doing-this">#</a></h2>
<ul>
<li>
<p>Create a big 32Go+ file using fallocate (Sentry Mode will not work if size &lt; 32G)</p>
<pre tabindex="0"><code>sudo fallocate /tesladrive -l 48G
</code></pre></li>
<li>
<p>Create the main script  in <code>/usr/local/bin/tesladrive.sh</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># mount as loop</span>
</span></span><span class="line"><span class="cl">mkdir -p /mnt/tesladrive
</span></span><span class="line"><span class="cl">losetup  /dev/loop2 /tesladrive
</span></span><span class="line"><span class="cl">mount -t exfat -o <span class="nv">offset</span><span class="o">=</span>1048576,time_offset<span class="o">=</span>-420 /dev/loop2 /mnt/tesladrive
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># swap the lock chime</span>
</span></span><span class="line"><span class="cl">cp <span class="k">$(</span>find /mnt/tesladrive/chimes/ -maxdepth <span class="m">1</span> -type f <span class="p">|</span> shuf -n 1<span class="k">)</span> /mnt/tesladrive/LockChime.wav
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># unmount</span>
</span></span><span class="line"><span class="cl">umount /mnt/tesladrive
</span></span><span class="line"><span class="cl">losetup -d /dev/loop2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># g_mass_storage</span>
</span></span><span class="line"><span class="cl">modprobe g_mass_storage <span class="nv">file</span><span class="o">=</span>/tesladrive <span class="nv">stall</span><span class="o">=</span><span class="m">0</span>
</span></span></code></pre></div><p>The script is fairly simple, it is left as an exercise for the reader (and future me) to figure it out.
The only weird thing is the <code>offset</code> argument to the mount command. This is because the device is /dev/loop2,
but the exfat partition is actually /dev/loop2p1, which isn&rsquo;t starting on the same block (thx exfat).
So to mount it, you must tell mount how much offset to the actual start of the exfat partition.</p>
<p>Here is what <code>fdisk</code> returns for our loopdevice:</p>
<pre tabindex="0"><code>Disk /dev/loop2: 48 GiB, 51539607552 bytes, 100663296 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x83f38a18

Device       Boot Start       End   Sectors Size Id Type
/dev/loop2p1       2048 100663295 100661248  48G  7 HPFS/NTFS/exFAT
</code></pre><p>So to compute the offset for mount, we do <code>start sector</code> * <code>sector size</code>, in our case 2048*512=1048576</p>
<p>Your values <em>might</em> be different.</p>
</li>
<li>
<p>Create a service file for it:
The goal here is to make is start as early as possible during the boot process, hence the basic target.
Put it in <code>/etc/systemd/system/tesladrive.service</code></p>
<pre tabindex="0"><code>[Unit]
Description=Launch the tesla drive module as fast as possible
Before=basic.target
After=local-fs.target sysinit.target
DefaultDependencies=no

[Service]
ExecStart=/home/coco/tesladrive.sh

[Install]
WantedBy=basic.target
</code></pre><p>then enable the service:</p>
<pre tabindex="0"><code>systemctl enable tesladrive
</code></pre></li>
</ul>
<h2 id="create-the-fs-add-your-sounds-and-enjoy-">create the fs, add your sounds and enjoy !<a hidden class="anchor" aria-hidden="true" href="#create-the-fs-add-your-sounds-and-enjoy-">#</a></h2>
<p>Now, You can mount manually the partition and format at as exFat:</p>
<pre tabindex="0"><code>losetup  /dev/loop2 /tesladrive
mkfs.exfat /dev/loop2
</code></pre><p><strong>Note: I had an issue where the Tesla did not recognized the partition properly, and I had to format it from the Tesla.</strong></p>
<p>Inside, we&rsquo;ll create a <code>chimes</code> dir that will hold the available lock sounds.
The script will pick one randomly and set it as the default one each time.</p>
<p>Here is how the file structure should look like:</p>
<pre tabindex="0"><code>coco@teslapi:~ $ ls /mnt/tesladrive/
LockChime.wav  TeslaCam  chimes
coco@teslapi:~ $ ls /mnt/tesladrive/chimes/
90s-modem.wav           bipbip.wav         eternity.wav  ogs              pikachu.wav
airplane-seat-belt.wav  canttouchthis.wav  hadouken.wav  pac-man-die.wav
</code></pre><p>You can find locksounds online, for example here: <a href="https://www.notateslaapp.com/tesla-custom-lock-sounds/">https://www.notateslaapp.com/tesla-custom-lock-sounds/</a></p>
<p>One thing to note is that the volume can be quite high on some of them. I used <code>sox</code> to reduce it for all of them, as to not be overly loud (but still funny):</p>
<pre tabindex="0"><code>sox -v 0.3 lock.wav lock_low.wav
</code></pre><p>(From <a href="https://stackoverflow.com/questions/21776073/reduce-volume-of-audio-file-by-percentage-value-using-sox">https://stackoverflow.com/questions/21776073/reduce-volume-of-audio-file-by-percentage-value-using-sox</a>)</p>
<p>Finally, plug the Pi in the USB port in the Tesla&rsquo;s glovebox, select Lock sound: &lsquo;USB&rsquo;, then step away from the car.</p>
<p>Every time the car starts up, this will start the Pi, which will swap the lock sound before mounting the partition as a mass storage for the tesla, changing the lock sound !</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/raspberrypi/">Raspberrypi</a></li>
      <li><a href="/tags/tesla/">Tesla</a></li>
      <li><a href="/tags/wav/">Wav</a></li>
      <li><a href="/tags/g_mass_storage/">G_mass_storage</a></li>
      <li><a href="/tags/exfat/">Exfat</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="/posts/state-of-the-setup-2024/">
    <span class="title">« Prev</span>
    <br>
    <span>State of the Setup 2024</span>
  </a>
  <a class="next" href="/posts/e-paper-frame/">
    <span class="title">Next »</span>
    <br>
    <span>E Ink Message frame</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="/">k0rventen&#39;s blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
