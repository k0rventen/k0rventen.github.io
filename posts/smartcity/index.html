<!doctype html><html lang=en><head><title>A smart city demonstrator ::
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A smart city model that I helped build a few years back, to better explain what IoT could mean for a city:
what &amp;amp; why When I arrived at $old_job in 2019, one of my first project was to build a small scale, smart city model that could :
be tranported anywhere, be installed on a table easily show what improvements to city life could be made using IoT and be pretty to lure people on our stands ;) The actual model was built by architecture students, with whom I devised a plan to integrate various sensors, LEDs and interactive elements to play with."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/smartcity/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="A smart city demonstrator"><meta name=twitter:description content="Integrating IoT at city-scale"><meta property="og:title" content="A smart city demonstrator"><meta property="og:description" content="Integrating IoT at city-scale"><meta property="og:type" content="article"><meta property="og:url" content="/posts/smartcity/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-10T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-10T00:00:00+00:00"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>k0rventen:~</span>
<span class=logo__cursor></span>
</a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/manpage>manpage</a></li><li><a href=/>posts</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/manpage>manpage</a></li><li><a href=/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>A smart city demonstrator</h1><div class=post-meta><span class=post-date>2024-01-10
</span><span class=post-read-time>— 5 min read</span></div><span class=post-tags><a href=/tags/smartcity/>#smartcity</a>&nbsp;
<a href=/tags/embedded/>#embedded</a>&nbsp;
<a href=/tags/arduino/>#arduino</a>&nbsp;
<a href=/tags/lora/>#lora</a>&nbsp;</span><div class=post-content><h2>Table of Contents</h2><aside class=table-of-contents><nav id=TableOfContents><ul><li><a href=#what--why>what & why</a></li><li><a href=#how>how</a><ul><li><ul><li><a href=#hardware-listing>Hardware listing</a></li></ul></li><li><a href=#configuration-adjustements>Configuration adjustements</a></li><li><a href=#scenarios>Scenarios</a></li><li><a href=#payload-structure-of-the-lora-frame>Payload structure of the LoRa frame</a></li><li><a href=#cloud-platform>cloud platform</a></li></ul></li></ul></nav></aside><p><em>A smart city model that I helped build a few years back, to better explain what IoT could mean for a city:</em></p><p><img src=/smartcity/smartcity-cl24.jpeg alt=demo></p><h1 id=what--why>what & why</h1><p>When I arrived at $old_job in 2019, one of my first project was to build a small scale, smart city model that could :</p><ul><li>be tranported anywhere,</li><li>be installed on a table easily</li><li>show what improvements to city life could be made using IoT</li><li>and be pretty to lure people on our stands ;)</li></ul><p>The actual model was built by architecture students, with whom I devised a plan to integrate various sensors, LEDs and interactive elements to play with.
The whole thing took around a week to be finished.</p><p>The model has been on display at Cisco Live 2019 and 2024 (that&rsquo;s the picture above), at various events in France (Salon des Maires..) and is now at Axians in La Defense.</p><h1 id=how>how</h1><p>Full code is here: <a href=https://github.com/k0rventen/smartcity>https://github.com/k0rventen/smartcity</a></p><p>Here is a quick diagram showing every major component of the model :</p><p><img src=/smartcity/diagram.png alt=diagram></p><ul><li>Various sensors (temperature, humidity, noise, parking spots..) are connected to Arduinos equipped with LoRa antennas, that transmits to a nearby 4G LoRa gateway.</li><li>Data & management informations are uploaded to our Acklio server.</li><li>Actual sensor data is retrieved by an AWS instance for decoding/storage/visualisation.</li></ul><p>Each section below is describing one of those components.</p><h3 id=hardware-listing>Hardware listing</h3><p>Here is a list of the hardware components used in the smart city model :</p><ul><li>3 <a href=https://www.gotronic.fr/art-carte-uno-r3-uno-v3-26125.htm>Arduino Uno</a> as micro-controllers, on top of which sits:<ul><li><a href=https://www.gotronic.fr/art-module-grove-base-shield-103030000-19068.htm>Grove Hat</a> for easy cable management, with the following sensors :<ul><li><a href=https://www.gotronic.fr/art-capteur-de-temperature-grove-101020015-18965.htm>Temperature sensor</a>,</li><li><a href=https://www.gotronic.fr/art-capteur-sonore-grove-101020063-20631.htm>Noise sensor</a>,</li><li><a href=https://www.gotronic.fr/art-detecteur-de-lumiere-grove-v1-2-101020132-25427.htm>Light sensor</a>,</li><li><a href=https://www.gotronic.fr/art-capteur-a-effet-hall-grove-101020046-18985.htm>Hall effect sensors</a>,</li><li><a href=https://www.gotronic.fr/art-led-8-mm-rgb-variable-grove-101020472-27991.htm>Standard LEDs</a>,</li><li><a href=https://www.gotronic.fr/art-led-8-mm-rgb-grove-v2-0-104020048-27067.htm>Chainable LEDs</a>,</li><li><a href=https://www.gotronic.fr/art-telemetre-a-ultrasons-grove-101020010-18976.htm>Ultrasonic distance sensors</a>,</li></ul></li><li>A <a href=https://www.cooking-hacks.com/lorawan-radio-shield-for-arduino-868-mhz>LoRaWAN antenna</a>, to upload the gathered data to a nearby gateway,</li></ul></li><li>A <a href=https://www.multitech.com/brands/multiconnect-conduit-ap>Multitech LoRa gateaway</a>, to receive the payloads from the antenna</li></ul><p>Each arduino is responsible for a specific task :</p><ul><li>Arduino 1 is managing the street lamps and monitoring the temperature / noise level of the city,</li><li>Arduino 2 is managing the city&rsquo;s trash cans</li><li>Arduino 3 is managing the parking spots</li></ul><h2 id=configuration-adjustements>Configuration adjustements</h2><p>The same boilerplate file is deployed to every arduino. The logic is the same everywhere, the arduino fetches the sensors and uploads their data to the cloud through an LoRa gateway. The only difference between each Arduino is which sensors are connected and on which pin.</p><p>This is the configuration currently is use in the model in <code>header.hpp</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> UltrasonicSensors[] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>4</span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> HallSensors[] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>6</span>,<span style=color:#ae81ff>7</span>,<span style=color:#ae81ff>8</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>5</span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> TemperatureSensor <span style=color:#f92672>=</span> A2;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> SoundSensor <span style=color:#f92672>=</span> A3;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> BrightnessSensor <span style=color:#f92672>=</span> A1;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> FloodSensor <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> FloodLED <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> WasteLEDs[] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>6</span>,<span style=color:#ae81ff>7</span>,<span style=color:#ae81ff>8</span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> ParkingLEDS[] <span style=color:#f92672>=</span> {A2,A3,<span style=color:#ae81ff>9</span>,<span style=color:#ae81ff>4</span>,A0,A1};
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> StreetLampsNumber <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>;
</span></span><span style=display:flex><span>ChainableLED <span style=color:#a6e22e>StreetLamps</span>(<span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>5</span>, StreetLampsNumber);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>int</span> RUNTIME_INTERVAL <span style=color:#f92672>=</span> <span style=color:#ae81ff>1000</span>;   <span style=color:#75715e>//! time in ms between runs
</span></span></span></code></pre></div><p>This <code>header.hpp</code> reflects:</p><ul><li>which scenarios are being used by this arduino (using the <code>#DEFINE</code> statements)</li><li>which sensors are connected to the arduino and their positions on the Grove Hat.</li></ul><h2 id=scenarios>Scenarios</h2><p>The scenarios are also defined in the <code>.hpp</code> file, so they are only compiled/present on the arduinos that need them.
For example the parking scenario, which returns the occupancy for 6 parking spots on the model:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#ifdef PARKINGSCENARIO
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @brief Scenario that controls the parking spots of the city.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Each parking spot is monitored and connected to a LED.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * If the parking sport is taken, the LED is up.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>ParkingScenario</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> HallSensorsLen; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>bool</span> isTaken <span style=color:#f92672>=</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>digitalRead</span>(HallSensors[i]);
</span></span><span style=display:flex><span><span style=color:#75715e>#ifdef DEBUG
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Serial.<span style=color:#a6e22e>print</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\t</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        Serial.<span style=color:#a6e22e>print</span>(i);
</span></span><span style=display:flex><span>        Serial.<span style=color:#a6e22e>print</span>(<span style=color:#e6db74>&#34; -&gt; &#34;</span>);
</span></span><span style=display:flex><span>        Serial.<span style=color:#a6e22e>println</span>(isTaken);
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (isTaken)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>SetLedStatus</span>(ParkingLEDS[i], HIGH);
</span></span><span style=display:flex><span>            LoRaPayload[i <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;1&#39;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>SetLedStatus</span>(ParkingLEDS[i], LOW);
</span></span><span style=display:flex><span>            LoRaPayload[i <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0&#39;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span></code></pre></div><h2 id=payload-structure-of-the-lora-frame>Payload structure of the LoRa frame</h2><p>Each arduino has it&rsquo;s own various data to send, so each payload is different :</p><p><strong>Garbage scenario</strong></p><table><thead><tr><th>Byte num</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th></tr></thead><tbody><tr><td>Desc</td><td>Trash 1</td><td>Null</td><td>Trash 2</td><td>Null</td><td>Trash 3</td></tr><tr><td>Value</td><td>1</td><td>0</td><td>1</td><td>0</td><td>1</td></tr></tbody></table><p>Explanations :</p><ul><li>Trash : 1 means the trashcan is full, 0 means it&rsquo;s not.</li></ul><p><strong>Parking scenario</strong></p><table><thead><tr><th>Byte num</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th></tr></thead><tbody><tr><td>Desc</td><td>Parking 1</td><td>Null</td><td>Parking 2</td><td>Null</td><td>Parking 3</td><td>Null</td><td>Parking 4</td><td>Null</td><td>Parking 5</td><td>Null</td><td>Parking 6</td></tr><tr><td>Value</td><td>1</td><td>0</td><td>1</td><td>0</td><td>0</td><td>0</td><td>1</td><td>0</td><td>0</td><td>0</td><td>1</td></tr></tbody></table><p>Explanations :</p><ul><li>Parking : 1 means the parking spot is taken, 0 means it&rsquo;s free.</li></ul><p><strong>Street lamps & metrics scenario</strong></p><table><thead><tr><th>Byte num</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th></tr></thead><tbody><tr><td>Desc</td><td>Lights status</td><td>Null</td><td>Null</td><td>Flood status</td><td>Null</td><td>Null</td><td>Null</td><td>Null</td><td>Null</td><td>Null</td><td>Light level</td><td>Light level</td><td>Noise</td><td>Noise</td><td>Temp</td><td>Temp</td></tr><tr><td>Value</td><td>1</td><td>0</td><td>0</td><td>1</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>8</td><td>9</td><td>4</td><td>8</td><td>2</td><td>5</td></tr></tbody></table><p>Explanations :</p><ul><li>Lights status : 1 means the lights are on, 0 means off.</li><li>Flood status : 1 means flood detected, 0 means no flood detected</li><li>Light level : Bytes 10 and 11 are forming a numnber reflecting the percentage of light perceived by the sensor, here 89%.</li><li>Noise : Bytes 12 and 13 are the current noise level reading in decibels. Here is 48 dB.</li><li>Temp : Bytes 14 and 15, the current temperature reading in Celsius, here 25°C.</li></ul><h2 id=cloud-platform>cloud platform</h2><p>A &lsquo;cloud&rsquo; platform gathers the data sent by the model through a LoRa GW. It&rsquo;s a simple python worker that translates MQTT messages to influxDB. The latter is used by Grafana to display &rsquo;live&rsquo; and historical data:</p><p><img src=/smartcity/grafana.jpg alt=grafana></p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/shared-docker-registry-ci/><span class=button__icon>←</span>
<span class=button__text>Remote layer cache for multiple docker CI runners</span>
</a></span><span class="button next"><a href=/posts/watchy/><span class=button__text>An E-Ink watch</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>k0rventen:~</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>