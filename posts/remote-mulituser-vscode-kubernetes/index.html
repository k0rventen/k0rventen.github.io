<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Remote, multi-user VSCode running in kubernetes | k0rventen&#39;s blog</title>
<meta name="keywords" content="k8s, vscode, dev">
<meta name="description" content="a better work environment">
<meta name="author" content="">
<link rel="canonical" href="/posts/remote-mulituser-vscode-kubernetes/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="/posts/remote-mulituser-vscode-kubernetes/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="/posts/remote-mulituser-vscode-kubernetes/">
  <meta property="og:site_name" content="k0rventen&#39;s blog">
  <meta property="og:title" content="Remote, multi-user VSCode running in kubernetes">
  <meta property="og:description" content="a better work environment">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-01-01T00:00:00+00:00">
    <meta property="article:modified_time" content="2022-01-01T00:00:00+00:00">
    <meta property="article:tag" content="K8s">
    <meta property="article:tag" content="Vscode">
    <meta property="article:tag" content="Dev">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Remote, multi-user VSCode running in kubernetes">
<meta name="twitter:description" content="a better work environment">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/posts/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Remote, multi-user VSCode running in kubernetes",
      "item": "/posts/remote-mulituser-vscode-kubernetes/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Remote, multi-user VSCode running in kubernetes",
  "name": "Remote, multi-user VSCode running in kubernetes",
  "description": "a better work environment",
  "keywords": [
    "k8s", "vscode", "dev"
  ],
  "articleBody": "a fully featured, multi-user, dev env running on your k8s cluster that can coldboot in less than 10s\nThere should have been a video here but your browser does not seem to support it. what \u0026 why I use VS Code as my primary IDE for everything, from python development, to kubernetes/helm chart generation, even when building stuff for raspberry pico or arduino.\nMy daily workflow at work is :\ndevelop on vscode, mostly python/go, have docker installed and build my images on my computer, push them on a local (LAN) k8s cluster with a registry, redeploy on the cluster using skaffold by targeting the registry. But having most of the work done on my computer is not ideal. I need to have a shitload of stuff installed (vscode, dependencies, docker (which on mac runs on a vm).. ), and I have a massive cluster doing absolutely nothing out of that flow. So the goal here is to leverage as much as I possibly can from the server, and have the most lightweight local environment possible.\nAnd because this will be used to work as a team, we need this to be multi-user.\nBasically we want to go from that:\nto that :\nWith all that said, let’s deploy a multi user vscode environment in our kubernetes cluster !\nhow There is 2 main components that we’ll need to make this:\na docker image that will be ran in our cluster, and that will include everything we need a way of using this image as our remote environment (I assume an already running kubernetes cluster, if not there is a link to a guide in the second section)\nstep 1: making a code-server docker image The guys at CoderHQ have made a version of vscode that can run remotely (https://github.com/coder/code-server), and the interface is available through HTTP.\nSo we’ll use that to have VS Code running remotely. But we might want other things to be installed too, like a specific language env, a different shell…\nHere is the Dockerfile I use, that installs some utils for kubernetes, python, code-server and the fish shell:\n# base FROM ubuntu:20.04 # tools, shell, language support RUN apt update RUN DEBIAN_FRONTEND=noninteractive apt install curl htop git dnsutils less fish nano openssh-client python3 python3-pip python3-venv -y --no-install-recommends # k8s tools (docker client, kubectl, k9s, skaffold) COPY --from=docker:dind /usr/local/bin/docker /usr/local/bin/docker RUN curl -Lo kubectl \"https://dl.k8s.io/release/v1.22.0/bin/linux/amd64/kubectl\" \u0026\u0026 install kubectl /usr/local/bin/kubectl RUN curl -Lo skaffold \"https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64\" \u0026\u0026 install skaffold /usr/local/bin/skaffold RUN curl -Lo k9s.tar.gz \"https://github.com/derailed/k9s/releases/download/v0.25.8/k9s_Linux_x86_64.tar.gz\" \u0026\u0026 tar xvf k9s.tar.gz k9s \u0026\u0026 install k9s /usr/local/bin/k9s # code-server RUN curl -fsSL https://code-server.dev/install.sh | sh # config \u0026 cleanup (set shell, copy config, apt cleanup.. ) RUN chsh -s /usr/bin/fish COPY config/ /tmp/code RUN chmod a+x /tmp/code/bootstrap.fish RUN rm kubectl skaffold k9s.tar.gz k9s RUN apt-get clean \u0026\u0026 rm -rf /var/lib/apt/lists/* /var/tmp/* # mounted work dir WORKDIR /root/projects CMD [\"/tmp/code/bootstrap.fish\"] the /tmp/code/bootstrap.fish mentionned as the CMD is a script that creates some dirs, moves config in the right places, then starts vscode:\n#! /usr/bin/fish # copies the default config to the home dir is not present # and launches code-server as main process if test ! -e /root/.code echo \"creating ssh keys\" mkdir /root/.ssh chmod 700 /root/.ssh ssh-keygen -b 2048 -N \"\" -f /root/.ssh/id_rsa echo \"creating python venv\" python3 -m venv /root/dev-env echo \"creating config directories\" mkdir -p /root/.config/code-server/data mkdir -p /root/.config/code-server/extensions mkdir -p /root/.config/fish echo \"copying config\" mv -v /tmp/code/config.fish /root/.config/fish/config.fish mv -v /tmp/code/config.yaml /root/.config/code-server/config.yaml touch /root/.code end echo \"starting code server\" exec code-server --config=/root/.config/code-server/config.yaml /root/projects We need to do this when the container starts instead of when generating the image, because the /root folder will be mounted as a volume in our container, making our work data and project persistant, even if we upgrade the image or restart the container.\nAlso, the config.yaml from the exec line at the end is the code-server config to use. It binds to port 8080, sets the config paths, disables auth, telemetry \u0026 update checs.\nbind-addr: 0.0.0.0:8080 auth: none user-data-dir: \"/root/.config/code-server/data\" extensions-dir: \"/root/.config/code-server/extensions\" cert: false disable-telemetry: true disable-update-check: true If we were to start this image locally using docker with -p 8080:8080, we would find a vscode running on that port.\nstep 2: managing users through jupyterhub Using a single code-server is not a viable option because we would appear a a single user and each user would overlap with each other, and storage would be a mess. Each user would need its own folder, and not to mess with others, etc.. Not practical.\nSo to manage that, we’ll use jupyterhub ! From their github repo (https://github.com/jupyterhub/jupyterhub):\nWith JupyterHub you can create a multi-user Hub that spawns, manages, and proxies multiple instances of the single-user Jupyter notebook server.\nProject Jupyter created JupyterHub to support many users. The Hub can offer notebook servers to a class of students, a corporate data science workgroup, a scientific research project, or a high-performance computing group.\nAnd some smart folks have put an amazing tutorial here !\nSo for everything related to the basic setup, you can just follow along with their tutorial. It boils down to installing kube and installing helm.\nWe will also install docker as we only installed the client in our container, and will mount the docker socket in our pod. Note that this is not the most secure approach, and might get revised in the future.\nIt is also favorable to install an ingress with kubernetes, as that will allow us to use a proper DNS name with HTTPS to access our vscode.\nThe next step from the guide is to actually install jupyterhub. For that, we’ll use this values.yaml:\nsingleuser: image: name: \"registry.gitlab.com/alpha-caeli/tooling/code-server\" # where your image is stored tag: \"latest\" storage: homeMountPath: \"/root\" # for storage persistence proxy: chp: extraCommandLineFlags: - \"--no-include-prefix\" secretToken: seed_a_random_token_here # change that hub: extraConfig: code_spawner.py: | # use the kubespawner connector # https://github.com/jupyterhub/kubespawner from kubespawner.spawner import KubeSpawner c.JupyterHub.spawner_class = KubeSpawner code_settings.py: | # run our bootstrap script c.KubeSpawner.cmd = [] # always pull our image c.KubeSpawner.image_pull_policy = \"Always\" # as our user c.KubeSpawner.uid = None c.KubeSpawner.gid = None c.KubeSpawner.port = 8080 c.KubeSpawner.mem_guarantee = \"400M\" # use our own SA c.KubeSpawner.service_account = \"code-server\" c.KubeSpawner.automount_service_account_token = True # use user/pass to auth to jupyterhub c.JupyterHub.authenticator_class = 'firstuseauthenticator.FirstUseAuthenticator' c.Authenticator.admin_users = {'admin'} # and mount the docker socket c.KubeSpawner.volume_mounts += [{\"mountPath\":\"/var/run/docker.sock\",\"name\":\"docker-sock\"},] c.KubeSpawner.volumes += [{\"name\":\"docker-sock\",\"hostPath\":{\"path\":\"/var/run/docker.sock\"}}] (don’t forget to edit values.yaml with a random token (using openssl rand -hex 32 for example) and correct admin user)\nJupyterHub will use the KubeSpawner instance to talk to kubernetes and create on-the-fly a pod whenever a new user connects. Pretty cool.\nThen add the jupyterhub helm chart:\nhelm repo add jupyterhub https://jupyterhub.github.io/helm-chart/ helm repo update now deploy it :\nhelm upgrade --cleanup-on-fail \\ --install vs-code-remote jupyterhub/jupyterhub \\ --namespace \\ --version=1.2.0 \\ --values values.yaml Wait a bit, then looking for pods with the jupyterhub label should output something like that:\n\u003e k get pods -l app=jupyterhub NAME READY STATUS RESTARTS AGE proxy-757bbc65-6t2hv 1/1 Running 3 26d continuous-image-puller-tn6n4 1/1 Running 3 26d user-scheduler-7fcb988779-z4zr5 1/1 Running 1 4d8h user-scheduler-7fcb988779-sh2kj 1/1 Running 0 3d8h hub-6d94767744-xqb6s 1/1 Running 0 2d9h To access vscode securely, let’s create a ingress.yaml that routes the jupyterhub proxy svc to a given dns endpoint. Edit the host to match your cluster’s DNS endpoint (or none for the IP):\napiVersion: extensions/v1beta1 kind: Ingress metadata: name: vs-code-remote spec: rules: - host: code.mycluster.lan http: paths: - backend: serviceName: proxy-public servicePort: 80 path: / pathType: Prefix tls: - hosts: - code.mycluster.lan --- apiVersion: v1 kind: Service metadata: annotations: meta.helm.sh/release-name: vs-code-remote labels: app: jupyterhub app.kubernetes.io/managed-by: Helm chart: jupyterhub-1.2.0 component: proxy-public heritage: Helm release: vs-code-remote name: proxy-public spec: ports: - name: http port: 80 protocol: TCP targetPort: http selector: component: proxy release: vs-code-remote sessionAffinity: None type: ClusterIP status: loadBalancer: {} We’ll also create a rbac.yaml that creates a dedicated service account for the vs-code pod, so that we can talk to the kube api from there (to deploy/restart services).\napiVersion: v1 automountServiceAccountToken: true kind: ServiceAccount metadata: name: code-server --- # RB for the SA apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: code-server subjects: - kind: ServiceAccount name: code-server roleRef: kind: Role name: code-server apiGroup: rbac.authorization.k8s.io --- # Permissions for the SA apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: code-server rules: - apiGroups: [\"\"] resources: [\"pods\",\"pods/log\",\"services\",\"persistentvolumeclaims\",\"configmaps\",\"secrets\"] verbs: [\"get\", \"list\",\"watch\",\"create\",\"patch\",\"update\",\"delete\"] - apiGroups: [\"apps\"] resources: [\"deployments\",\"statefulsets\",\"replicasets\",\"daemonsets\"] verbs: [\"get\", \"list\",\"watch\",\"create\",\"patch\",\"update\",\"delete\"] - apiGroups: [\"networking.k8s.io\"] resources: [\"ingresses\"] verbs: [\"get\", \"list\",\"watch\",\"create\",\"patch\",\"update\",\"delete\"] We can apply those now:\n# we have to delete the service beforehand because we can't patch when changing the type of Service k delete svc proxy-public # apply our mods k apply -f ingress.yaml k apply -f rbac.yaml You can now go to the endpoint, and you’ll be greeted by the jupyterhub login page.\nThe first time you login, it will record your user/password combo.\nOnce you’re in, a pod will be created for your environment, and you should see the familiar vscode interface.\nThere should have been a video here but your browser does not seem to support it. And voila! You can now use the power of your cluster to handle the majority of your workflow, while making your laptop cooler and maybe quieter !\n",
  "wordCount" : "1519",
  "inLanguage": "en",
  "datePublished": "2022-01-01T00:00:00Z",
  "dateModified": "2022-01-01T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/posts/remote-mulituser-vscode-kubernetes/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "k0rventen's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="&gt; k0rventen: ~ (Alt + H)">&gt; k0rventen: ~</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="/links" title="links">
                    <span>links</span>
                </a>
            </li>
            <li>
                <a href="/posts" title="posts">
                    <span>posts</span>
                </a>
            </li>
            <li>
                <a href="/search" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Remote, multi-user VSCode running in kubernetes
    </h1>
    <div class="post-description">
      a better work environment
    </div>
    <div class="post-meta"><span title='2022-01-01 00:00:00 +0000 UTC'>January 1, 2022</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;1519 words

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#step-1-making-a-code-server-docker-image">step 1: making a code-server docker image</a></li>
    <li><a href="#step-2-managing-users-through-jupyterhub">step 2: managing users through jupyterhub</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p><em>a fully featured, multi-user, dev env running on your k8s cluster that can coldboot in less than 10s</em></p>
<video class="video-shortcode" preload="auto" controls autoplay width="100%">
  <source src="/remote-vscode/demo.mp4" type="video/mp4">
  There should have been a video here but your browser does not seem to support it.
</video>
<h1 id="what--why">what &amp; why<a hidden class="anchor" aria-hidden="true" href="#what--why">#</a></h1>
<p>I use VS Code as my primary IDE for everything, from python development, to kubernetes/helm chart generation, even when building stuff for raspberry pico or arduino.</p>
<p>My daily workflow at work is :</p>
<ul>
<li>develop on vscode, mostly python/go,</li>
<li>have docker installed and build my images on my computer,</li>
<li>push them on a local (LAN) k8s cluster with a registry,</li>
<li>redeploy on the cluster using <a href="https://skaffold.dev">skaffold</a> by targeting the registry.</li>
</ul>
<p>But having most of the work done on my computer is not ideal. I need to have a shitload of stuff installed (vscode, dependencies, docker (which on mac runs on a vm).. ), and I have a massive cluster doing absolutely nothing out of that flow. So the goal here is to leverage as much as I possibly can from the server, and have the most lightweight local environment possible.</p>
<p>And because this will be used to work as a team, we need this to be multi-user.</p>
<p>Basically we want to go from that:</p>
<p><img alt="now" loading="lazy" src="/remote-vscode/current.png"></p>
<p>to that :</p>
<p><img alt="next" loading="lazy" src="/remote-vscode/next.png"></p>
<p>With all that said, let&rsquo;s deploy a multi user vscode environment in our kubernetes cluster !</p>
<h1 id="how">how<a hidden class="anchor" aria-hidden="true" href="#how">#</a></h1>
<p>There is 2 main components that we&rsquo;ll need to make this:</p>
<ul>
<li>a docker image that will be ran in our cluster, and that will include everything we need</li>
<li>a way of using this image as our remote environment</li>
</ul>
<p>(I assume an already running kubernetes cluster, if not there is a link to a guide in the second section)</p>
<h2 id="step-1-making-a-code-server-docker-image">step 1: making a code-server docker image<a hidden class="anchor" aria-hidden="true" href="#step-1-making-a-code-server-docker-image">#</a></h2>
<p>The guys at CoderHQ have made a version of vscode that can run remotely (<a href="https://github.com/coder/code-server)">https://github.com/coder/code-server)</a>, and the interface is available through HTTP.</p>
<p>So we&rsquo;ll use that to have VS Code running remotely. But we might want other things to be installed too, like a specific language env, a different shell&hellip;</p>
<p>Here is the Dockerfile I use, that installs some utils for kubernetes, python, code-server and the fish shell:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="c"># base</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> ubuntu:20.04</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># tools, shell, language support</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt update<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt install curl htop git dnsutils less fish nano openssh-client python3 python3-pip python3-venv -y --no-install-recommends<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># k8s tools (docker client, kubectl, k9s, skaffold)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>docker:dind /usr/local/bin/docker /usr/local/bin/docker<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> curl -Lo kubectl  <span class="s2">&#34;https://dl.k8s.io/release/v1.22.0/bin/linux/amd64/kubectl&#34;</span> <span class="o">&amp;&amp;</span> install kubectl /usr/local/bin/kubectl<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> curl -Lo skaffold <span class="s2">&#34;https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64&#34;</span> <span class="o">&amp;&amp;</span> install skaffold /usr/local/bin/skaffold <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> curl -Lo k9s.tar.gz <span class="s2">&#34;https://github.com/derailed/k9s/releases/download/v0.25.8/k9s_Linux_x86_64.tar.gz&#34;</span> <span class="o">&amp;&amp;</span> tar xvf k9s.tar.gz k9s <span class="o">&amp;&amp;</span> install k9s /usr/local/bin/k9s<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># code-server</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> curl -fsSL https://code-server.dev/install.sh <span class="p">|</span> sh<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># config &amp; cleanup (set shell, copy config, apt cleanup.. )</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> chsh -s /usr/bin/fish<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> config/ /tmp/code<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> chmod a+x /tmp/code/bootstrap.fish<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> rm kubectl skaffold k9s.tar.gz k9s<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt-get clean <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/* /var/tmp/*<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># mounted work dir</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /root/projects</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;/tmp/code/bootstrap.fish&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></div><p>the <code>/tmp/code/bootstrap.fish</code> mentionned as the CMD is a script that creates some dirs, moves  config in the right places, then starts vscode:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#! /usr/bin/fish
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1"># copies the default config to the home dir is not present</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and launches code-server as main process</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> ! -e /root/.code
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;creating ssh keys&#34;</span>
</span></span><span class="line"><span class="cl">    mkdir /root/.ssh
</span></span><span class="line"><span class="cl">    chmod <span class="m">700</span> /root/.ssh
</span></span><span class="line"><span class="cl">    ssh-keygen -b <span class="m">2048</span> -N <span class="s2">&#34;&#34;</span> -f /root/.ssh/id_rsa
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;creating python venv&#34;</span>
</span></span><span class="line"><span class="cl">    python3 -m venv /root/dev-env
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;creating config directories&#34;</span>
</span></span><span class="line"><span class="cl">    mkdir -p /root/.config/code-server/data
</span></span><span class="line"><span class="cl">    mkdir -p /root/.config/code-server/extensions
</span></span><span class="line"><span class="cl">    mkdir -p /root/.config/fish
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;copying config&#34;</span>
</span></span><span class="line"><span class="cl">    mv -v /tmp/code/config.fish   /root/.config/fish/config.fish
</span></span><span class="line"><span class="cl">    mv -v /tmp/code/config.yaml   /root/.config/code-server/config.yaml
</span></span><span class="line"><span class="cl">    touch /root/.code
</span></span><span class="line"><span class="cl">end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;starting code server&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> code-server --config<span class="o">=</span>/root/.config/code-server/config.yaml /root/projects
</span></span></code></pre></div><p>We need to do this when the container starts instead of when generating the image, because the <code>/root</code> folder will be mounted as a volume in our container, making our work data and project persistant, even if we upgrade the image or restart the container.</p>
<p>Also, the <code>config.yaml</code> from the exec line at the end is the code-server config to use. It binds to port 8080, sets the config paths, disables auth, telemetry &amp; update checs.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">bind-addr</span><span class="p">:</span><span class="w"> </span><span class="m">0.0.0.0</span><span class="p">:</span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">auth</span><span class="p">:</span><span class="w"> </span><span class="l">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">user-data-dir</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/root/.config/code-server/data&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">extensions-dir</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/root/.config/code-server/extensions&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">cert</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">disable-telemetry</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">disable-update-check</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>If we were to start this image locally using docker with <code>-p 8080:8080</code>, we would find a vscode running on that port.</p>
<h2 id="step-2-managing-users-through-jupyterhub">step 2: managing users through jupyterhub<a hidden class="anchor" aria-hidden="true" href="#step-2-managing-users-through-jupyterhub">#</a></h2>
<p>Using a single code-server is not a viable option because we would appear a a single user and each user would overlap with each other, and storage would be a mess. Each user would need its own folder, and not to mess with others, etc.. Not practical.</p>
<p>So to manage that, we&rsquo;ll use jupyterhub ! From their github repo (<a href="https://github.com/jupyterhub/jupyterhub)">https://github.com/jupyterhub/jupyterhub)</a>:</p>
<p><em>With JupyterHub you can create a multi-user Hub that spawns, manages, and proxies multiple instances of the single-user Jupyter notebook server.</em></p>
<p><em>Project Jupyter created JupyterHub to support many users. The Hub can offer notebook servers to a class of students, a corporate data science workgroup, a scientific research project, or a high-performance computing group.</em></p>
<p>And some smart folks have put an amazing tutorial <a href="https://zero-to-jupyterhub.readthedocs.io/en/latest/index.html">here</a> !</p>
<p>So for everything related to the basic setup, you can just follow along with their tutorial.
It boils down to installing kube and installing helm.</p>
<p>We will also install docker as we only installed the client in our container, and will mount the docker socket in our pod. Note that this is not the <strong>most</strong> secure approach, and might get revised in the future.</p>
<p>It is also favorable to install an ingress with kubernetes, as that will allow us to use a proper DNS name with HTTPS to access our vscode.</p>
<p>The next step from the guide is to actually install jupyterhub. For that, we&rsquo;ll use this <code>values.yaml</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">singleuser</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;registry.gitlab.com/alpha-caeli/tooling/code-server&#34;</span><span class="w"> </span><span class="c"># where your image is stored</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;latest&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storage</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">homeMountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/root&#34;</span><span class="w"> </span><span class="c"># for storage persistence</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">proxy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">chp</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">extraCommandLineFlags</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;--no-include-prefix&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">secretToken</span><span class="p">:</span><span class="w"> </span><span class="l">seed_a_random_token_here</span><span class="w"> </span><span class="c"># change that</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">hub</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">extraConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">code_spawner.py</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      # use the kubespawner connector
</span></span></span><span class="line"><span class="cl"><span class="sd">      # https://github.com/jupyterhub/kubespawner
</span></span></span><span class="line"><span class="cl"><span class="sd">      from kubespawner.spawner import KubeSpawner
</span></span></span><span class="line"><span class="cl"><span class="sd">      c.JupyterHub.spawner_class = KubeSpawner</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">code_settings.py</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      # run our bootstrap script
</span></span></span><span class="line"><span class="cl"><span class="sd">      c.KubeSpawner.cmd = []
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      # always pull our image
</span></span></span><span class="line"><span class="cl"><span class="sd">      c.KubeSpawner.image_pull_policy = &#34;Always&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      # as our user
</span></span></span><span class="line"><span class="cl"><span class="sd">      c.KubeSpawner.uid = None
</span></span></span><span class="line"><span class="cl"><span class="sd">      c.KubeSpawner.gid = None
</span></span></span><span class="line"><span class="cl"><span class="sd">      c.KubeSpawner.port = 8080
</span></span></span><span class="line"><span class="cl"><span class="sd">      c.KubeSpawner.mem_guarantee = &#34;400M&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      # use our own SA
</span></span></span><span class="line"><span class="cl"><span class="sd">      c.KubeSpawner.service_account = &#34;code-server&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">      c.KubeSpawner.automount_service_account_token = True
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      # use user/pass to auth to jupyterhub
</span></span></span><span class="line"><span class="cl"><span class="sd">      c.JupyterHub.authenticator_class = &#39;firstuseauthenticator.FirstUseAuthenticator&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">      c.Authenticator.admin_users = {&#39;admin&#39;}
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      # and mount the docker socket 
</span></span></span><span class="line"><span class="cl"><span class="sd">      c.KubeSpawner.volume_mounts += [{&#34;mountPath&#34;:&#34;/var/run/docker.sock&#34;,&#34;name&#34;:&#34;docker-sock&#34;},]
</span></span></span><span class="line"><span class="cl"><span class="sd">      c.KubeSpawner.volumes += [{&#34;name&#34;:&#34;docker-sock&#34;,&#34;hostPath&#34;:{&#34;path&#34;:&#34;/var/run/docker.sock&#34;}}]</span><span class="w">      
</span></span></span></code></pre></div><p>(don&rsquo;t forget to edit <code>values.yaml</code> with a random token (using <code>openssl rand -hex 32</code> for example) and correct admin user)</p>
<p>JupyterHub will use the KubeSpawner instance to talk to kubernetes and create <em>on-the-fly</em> a pod whenever a new user connects. Pretty cool.</p>
<p>Then add the jupyterhub helm chart:</p>
<pre tabindex="0"><code>helm repo add jupyterhub https://jupyterhub.github.io/helm-chart/
helm repo update
</code></pre><p>now deploy it :</p>
<pre tabindex="0"><code>helm upgrade --cleanup-on-fail \
  --install vs-code-remote jupyterhub/jupyterhub \
  --namespace &lt;namespace&gt; \
  --version=1.2.0 \
  --values values.yaml
</code></pre><p>Wait a bit, then looking for pods with the <code>jupyterhub</code> label should output something like that:</p>
<pre tabindex="0"><code>&gt; k get pods -l app=jupyterhub
NAME                              READY   STATUS    RESTARTS   AGE
proxy-757bbc65-6t2hv              1/1     Running   3          26d
continuous-image-puller-tn6n4     1/1     Running   3          26d
user-scheduler-7fcb988779-z4zr5   1/1     Running   1          4d8h
user-scheduler-7fcb988779-sh2kj   1/1     Running   0          3d8h
hub-6d94767744-xqb6s              1/1     Running   0          2d9h
</code></pre><p>To access vscode securely, let&rsquo;s create a <code>ingress.yaml</code> that routes the jupyterhub proxy svc to a given dns endpoint.
Edit the <code>host</code> to match your cluster&rsquo;s DNS endpoint (or none for the IP):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vs-code-remote</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">code.mycluster.lan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">proxy-public</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">code.mycluster.lan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">meta.helm.sh/release-name</span><span class="p">:</span><span class="w"> </span><span class="l">vs-code-remote</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">jupyterhub</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/managed-by</span><span class="p">:</span><span class="w"> </span><span class="l">Helm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">jupyterhub-1.2.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">proxy-public</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">heritage</span><span class="p">:</span><span class="w"> </span><span class="l">Helm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span><span class="l">vs-code-remote</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">proxy-public</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span><span class="l">vs-code-remote</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sessionAffinity</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loadBalancer</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></div><p>We&rsquo;ll also create a <code>rbac.yaml</code> that creates a dedicated service account for the vs-code pod, so that we can talk to the kube api
from there (to deploy/restart services).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">automountServiceAccountToken</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">code-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># RB for the SA</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">code-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">code-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">code-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Permissions for the SA</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">code-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;pods&#34;</span><span class="p">,</span><span class="s2">&#34;pods/log&#34;</span><span class="p">,</span><span class="s2">&#34;services&#34;</span><span class="p">,</span><span class="s2">&#34;persistentvolumeclaims&#34;</span><span class="p">,</span><span class="s2">&#34;configmaps&#34;</span><span class="p">,</span><span class="s2">&#34;secrets&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="s2">&#34;create&#34;</span><span class="p">,</span><span class="s2">&#34;patch&#34;</span><span class="p">,</span><span class="s2">&#34;update&#34;</span><span class="p">,</span><span class="s2">&#34;delete&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;apps&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;deployments&#34;</span><span class="p">,</span><span class="s2">&#34;statefulsets&#34;</span><span class="p">,</span><span class="s2">&#34;replicasets&#34;</span><span class="p">,</span><span class="s2">&#34;daemonsets&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="s2">&#34;create&#34;</span><span class="p">,</span><span class="s2">&#34;patch&#34;</span><span class="p">,</span><span class="s2">&#34;update&#34;</span><span class="p">,</span><span class="s2">&#34;delete&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;networking.k8s.io&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;ingresses&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="s2">&#34;create&#34;</span><span class="p">,</span><span class="s2">&#34;patch&#34;</span><span class="p">,</span><span class="s2">&#34;update&#34;</span><span class="p">,</span><span class="s2">&#34;delete&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>We can apply those now:</p>
<pre tabindex="0"><code># we have to delete the service beforehand because we can&#39;t patch when changing the type of Service
k delete svc proxy-public

# apply our mods
k apply -f ingress.yaml
k apply -f rbac.yaml
</code></pre><p>You can now go to the endpoint, and you&rsquo;ll be greeted by the jupyterhub login page.</p>
<p><img alt="jupyterhub-login" loading="lazy" src="/remote-vscode/jupyterhub-login.png"></p>
<p>The first time you login, it will record your user/password combo.</p>
<p>Once you&rsquo;re in, a pod will be created for your environment, and you should see the familiar vscode interface.</p>
<video class="video-shortcode" preload="auto" controls autoplay width="100%">
  <source src="/remote-vscode/demo.mp4" type="video/mp4">
  There should have been a video here but your browser does not seem to support it.
</video>
<p>And voila! You can now use the power of your cluster to handle the majority of your workflow, while making your laptop cooler and maybe quieter !</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/k8s/">K8s</a></li>
      <li><a href="/tags/vscode/">Vscode</a></li>
      <li><a href="/tags/dev/">Dev</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="/posts/basic-k8s-security/">
    <span class="title">« Prev</span>
    <br>
    <span>A basic, security-minded k8s app setup</span>
  </a>
  <a class="next" href="/posts/reducing-docker-images-size-using-xz/">
    <span class="title">Next »</span>
    <br>
    <span>Reducing Docker Images Size Using Xz</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="/">k0rventen&#39;s blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
