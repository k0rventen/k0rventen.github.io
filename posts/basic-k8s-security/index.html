<!doctype html><html lang=en><head><title>A basic, security-minded k8s app setup ::
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="what &amp;amp; why The CKS (Certified Kubernetes Security Specialist) is a great resource for knowing how to secure a kubernetes cluster. It covers a lot of topics, from the cluster side (admission controller, webhooks, audit), app side (Pod Security Policies) and supply chain (image scanning). Another great resource for this is the Kubernetes Hardening Guidance by NSA &amp;amp; CISA
But some of the concepts defined in both these resources are very case-specific, and require a lot of time, tools &amp;amp; effort to setup."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/basic-k8s-security/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="A basic, security-minded k8s app setup"><meta name=twitter:description content="Add a layer of security to your deployment without too much hassle"><meta property="og:title" content="A basic, security-minded k8s app setup"><meta property="og:description" content="Add a layer of security to your deployment without too much hassle"><meta property="og:type" content="article"><meta property="og:url" content="/posts/basic-k8s-security/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-09T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-09T00:00:00+00:00"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>k0rventen:~</span>
<span class=logo__cursor></span>
</a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/manpage>manpage</a></li><li><a href=/>posts</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/manpage>manpage</a></li><li><a href=/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>A basic, security-minded k8s app setup</h1><div class=post-meta><span class=post-date>2022-03-09
</span><span class=post-read-time>— 7 min read</span></div><span class=post-tags><a href=/tags/k8s/>#k8s</a>&nbsp;
<a href=/tags/security/>#security</a>&nbsp;
<a href=/tags/cks/>#CKS</a>&nbsp;</span><div class=post-content><h2>Table of Contents</h2><aside class=table-of-contents><nav id=TableOfContents><ul><li><ul><li><a href=#what--why>what & why</a></li><li><a href=#how>how</a><ul><li><a href=#non-root-user>non root user</a></li><li><a href=#runasuser>runAsUser</a></li><li><a href=#readonlyrootfilesystem>readOnlyRootFilesystem</a></li><li><a href=#automountserviceaccounttoken>automountServiceAccountToken</a></li><li><a href=#resources>resources</a></li><li><a href=#sha-tagging>SHA tagging</a></li><li><a href=#results>Results</a></li></ul></li></ul></li><li><a href=#further-resources>Further resources</a></li></ul></nav></aside><h2 id=what--why>what & why</h2><p>The CKS (Certified Kubernetes Security Specialist) is a great resource for knowing how to secure a kubernetes cluster.
It covers a lot of topics, from the cluster side (admission controller, webhooks, audit), app side (Pod Security Policies) and supply chain (image scanning). Another great resource for this is the <a href=https://media.defense.gov/2021/Aug/03/2002820425/-1/-1/1/CTR_KUBERNETESHARDENINGGUIDANCE.PDF>Kubernetes Hardening Guidance by NSA & CISA</a></p><p>But some of the concepts defined in both these resources are very case-specific, and require a lot of time, tools & effort to setup. In some environnements, it might be infeasible to deploy each and every one of those concepts. But that doesn&rsquo;t mean we should avoid some basic security-minded steps when deploying to k8s. I won&rsquo;t cover things on the cluster-side (audit, tools like falco, or admission controllers), but how you can improve the security of your front-facing app by adding a few lines here and there.</p><h2 id=how>how</h2><p>Let say we have a python app, that exposes an API. We have a basic Dockerfile for it, and a simple <code>deploy.yaml</code> spec file containing our Deployment. They are what you could call &rsquo;typical&rsquo; of what can be found online when looking for a template of dockerfile or deployment:</p><p>Dockerfile:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> python:3-alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> requirements.txt .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> pip3 install -r requirements.txt<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> src/ ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PYTHONUNBUFFERED <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> python3 app.py<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>deployment manifest:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>api</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>api</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>api</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>api</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry/api:latest</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>5000</span>
</span></span></code></pre></div><p>Let&rsquo;s secure things up :</p><h3 id=non-root-user>non root user</h3><p>The first recommendation is to run our containers as non-root users. For that, we&rsquo;ll first add a few lines to our Dockerfile:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span>...<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> addgroup -S app <span style=color:#f92672>&amp;&amp;</span> adduser -H -D -S app -G app -s /dev/null<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> app:app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p><strong>Note that we are using an alpine-based container, so the exact command might vary on other distros, but the goal is the same</strong></p><p>By creating a user &lsquo;app&rsquo;, and using it to run our app, we avoid giving <em>way too much</em> permissions to the app.
We can check that by exec&rsquo;ing into the running container:</p><p>(before)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/app <span style=color:#75715e># id</span>
</span></span><span style=display:flex><span>uid<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>1<span style=color:#f92672>(</span>bin<span style=color:#f92672>)</span>,2<span style=color:#f92672>(</span>daemon<span style=color:#f92672>)</span>,3<span style=color:#f92672>(</span>sys<span style=color:#f92672>)</span>,4<span style=color:#f92672>(</span>adm<span style=color:#f92672>)</span>,6<span style=color:#f92672>(</span>disk<span style=color:#f92672>)</span>,10<span style=color:#f92672>(</span>wheel<span style=color:#f92672>)</span>,11<span style=color:#f92672>(</span>floppy<span style=color:#f92672>)</span>,20<span style=color:#f92672>(</span>dialout<span style=color:#f92672>)</span>,26<span style=color:#f92672>(</span>tape<span style=color:#f92672>)</span>,27<span style=color:#f92672>(</span>video<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>/app <span style=color:#75715e># ps</span>
</span></span><span style=display:flex><span>PID   USER     TIME  COMMAND
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span> root      0:00 <span style=color:#f92672>{</span>flask-api.py<span style=color:#f92672>}</span> /usr/local/bin/python3 ./flask-api.py
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>7</span> root      0:00 sh
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>14</span> root      0:00 ps
</span></span></code></pre></div><p>(now)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/app $ id
</span></span><span style=display:flex><span>uid<span style=color:#f92672>=</span>101<span style=color:#f92672>(</span>app<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>101<span style=color:#f92672>(</span>app<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>/app $ ps
</span></span><span style=display:flex><span>PID   USER     TIME  COMMAND
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span> app       0:00 <span style=color:#f92672>{</span>flask-api.py<span style=color:#f92672>}</span> /usr/local/bin/python3 ./flask-api.py
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>7</span> app       0:00 sh
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>14</span> app       0:00 ps
</span></span></code></pre></div><p>Right, so now we are not running as root on the container side, but what about the host ? To which user are we mapped to on the host side ?</p><p>when running the default image:</p><pre tabindex=0><code>k8s-worker &gt; ps -aux | grep flask
root     2266529  1.8  0.1  28168 23752 ?        Ss   17:31   0:00 /usr/local/bin/python3 ./flask-api.py
</code></pre><p>We are actually mapped to the root user ! that&rsquo;s not the most secure setup ! If somehow an attacker gain control of the pod and is able to escape, he will land on the host as the root user.</p><p>And if we use the new Dockerfile with the USER directive:</p><pre tabindex=0><code>ps -aux | grep flask
syslog   2267104  2.8  0.1  28168 23812 ?        Ss   17:32   0:00 /usr/local/bin/python3 ./flask-api.py
</code></pre><p>What ? Why are we mapped to the syslog user ? A quick check of <em>/etc/passwd</em> shows us why :</p><pre tabindex=0><code>cat /etc/passwd | grep 101
syslog:x:101:107::/home/syslog:/usr/sbin/nologin
</code></pre><p>This is because when we created the user <code>app</code> in the Dockerfile, it assigned to it the uid 101, which is the same as the syslog user on our host.</p><p>To avoid clashing with a potential user with the same uid on the host, we can use a higher uid, in the <code>40000-60000</code> range.</p><h3 id=runasuser>runAsUser</h3><p>To fix that, we will tweak our <code>deploy.yaml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>api</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry/api:latest</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>securityContext</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsUser</span>: <span style=color:#ae81ff>60096</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsGroup</span>: <span style=color:#ae81ff>60096</span>
</span></span></code></pre></div><p>Now, from the host side, we will appear as uid <code>60096</code>, which isn&rsquo;t mapped to a predefined user (unless a user with the same uid exists on the host obviously).</p><h3 id=readonlyrootfilesystem>readOnlyRootFilesystem</h3><p>Another great addition to the Deployment spec, it to set the filesystem as readonly.
This will block any attempt to modify the filesystem of the container, like installing binaries, modifying configuration in /etc..</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>api</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry/api:latest</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>securityContext</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>readOnlyRootFilesystem</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsUser</span>: <span style=color:#ae81ff>60096</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsGroup</span>: <span style=color:#ae81ff>60096</span>
</span></span></code></pre></div><p>Now if we try to change something, we&rsquo;ll be greeted by an error message, preventing any change on the root fs:</p><pre tabindex=0><code>ERROR: Unable to lock database: Read-only file system
ERROR: Failed to open apk database: Read-only file system
</code></pre><p>If our app needs to be able to write in a given folder (like a /tmp/cache folder for caching), we can create a volumeMount in the deployment, mapped to an &rsquo;emptyDir&rsquo;. This will allow the app to write at this folder, while retaining the read-only root fs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>api</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry/api:latest</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/tmp/cache</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>cache-volume</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>cache-volume</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>emptyDir</span>: {}
</span></span></code></pre></div><h3 id=automountserviceaccounttoken>automountServiceAccountToken</h3><p>If the pod is not going to communicate with the kubernetes API, we can avoid mounting the service account&rsquo;s token in the pod (which by default will be mounted in <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>automountServiceAccountToken</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span></code></pre></div><h3 id=resources>resources</h3><p>While we&rsquo;re on the deployment, it&rsquo;s also a good idea to set some resources limits on the pod. This will prevent the pods from consuming all the resources from the host, which even if it&rsquo;s from a genuine mistake, can result in outages or other disurptions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>api</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry/api:latest</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>limits</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>500m</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>128Mi</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>100m</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>64Mi</span>
</span></span></code></pre></div><p><code>requests</code> will tell k8s the requirements for the pod, i.e what we can expect the pod to consume. This will aid the scheduling on an appropriate node.</p><p><code>limits</code> will actually stop the pod from consuming more than what is specified, either by throttling for the cpu, or OOM for the memory.</p><h3 id=sha-tagging>SHA tagging</h3><p>Another recommendation would be to use SHA tagging on the base image of our Dockerfile. This serves two purposes:</p><ul><li>making reproducible builds possible. Otherwise, as the base image can be updated, this will break our current setup even though our Dockerfile hasn&rsquo;t changed.</li><li>aleviate supply chain attacks: If the base image used is subject to a supply chain attack (a threat actor injects/modify the image), our image becomes subject as well because we&rsquo;ll pull the latest version of the image.</li></ul><p>To do so, we simply add the SHA of the image we want to fix at the end of the tag:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> python:3.9-alpine3.15@sha256:f2aeefbeb3846b146a8ad9b995af469d249272af804b309318e2c72c9ca035b0</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>We can repeat the same behavior on the deployment. Instead of using <code>registry/api:latest</code>, but by using a versionning scheme (like <a href=https://semver.org/>semver</a> or <a href=https://calver.org/>calver</a>) and combining this with the SHA of the image, we ensure that the image used in the deployment will not be updated due to upstream changes.</p><h3 id=results>Results</h3><p>Final versions of the Dockerfile and deploy.yaml would look like this:</p><p>Dockerfile</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> python:3.9-alpine3.15@sha256:f2aeefbeb3846b146a8ad9b995af469d249272af804b309318e2c72c9ca035b0</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> requirements.txt .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> pip3 install -r requirements.txt<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> addgroup -S app <span style=color:#f92672>&amp;&amp;</span> adduser -H -D -S app -G app -s /dev/null<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> app:app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> src/ ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PYTHONUNBUFFERED <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;python3&#34;</span>,<span style=color:#e6db74>&#34;app.py&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>deploy.yaml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>api</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>api</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>api</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>automountServiceAccountToken</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>api</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry/api:v1.0.3@sha256:f469d249272af80...</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>securityContext</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>readOnlyRootFilesystem</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsUser</span>: <span style=color:#ae81ff>69096</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsGroup</span>: <span style=color:#ae81ff>69096</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>5000</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/tmp/cache</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>cache-volume</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>cache-volume</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>emptyDir</span>: {}
</span></span></code></pre></div><p>Theses are simples yet effectives ways to secure your app on k8s. If you want to go deeper, I would suggests checking more advanced topics like host-side security (using apparmor profiles for example), falco , or supply chain security (Open Policy Agent, Admission controllers..). Theses are all topics that are covered by the CKS, and with plenty of information online.</p><h1 id=further-resources>Further resources</h1><ul><li><a href=https://pwning.systems/posts/escaping-containers-for-fun/>https://pwning.systems/posts/escaping-containers-for-fun/</a></li><li><a href=https://kubernetes.io/docs/concepts/storage/volumes/#emptydir>https://kubernetes.io/docs/concepts/storage/volumes/#emptydir</a></li><li><a href=https://kubernetes.io/docs/tasks/configure-pod-container/security-context/>https://kubernetes.io/docs/tasks/configure-pod-container/security-context/</a></li></ul></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/keda-autoscaling/><span class=button__icon>←</span>
<span class=button__text>Autoscaling using KEDA</span>
</a></span><span class="button next"><a href=/posts/remote-mulituser-vscode-kubernetes/><span class=button__text>Remote, multi-user VSCode running in kubernetes</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>k0rventen:~</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>