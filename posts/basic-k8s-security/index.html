<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>A basic, security-minded k8s app setup | k0rventen&#39;s blog</title>
<meta name="keywords" content="k8s, security, CKS">
<meta name="description" content="Add a layer of security to your deployment without too much hassle">
<meta name="author" content="">
<link rel="canonical" href="/posts/basic-k8s-security/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="/posts/basic-k8s-security/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="/posts/basic-k8s-security/">
  <meta property="og:site_name" content="k0rventen&#39;s blog">
  <meta property="og:title" content="A basic, security-minded k8s app setup">
  <meta property="og:description" content="Add a layer of security to your deployment without too much hassle">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-03-09T00:00:00+00:00">
    <meta property="article:modified_time" content="2022-03-09T00:00:00+00:00">
    <meta property="article:tag" content="K8s">
    <meta property="article:tag" content="Security">
    <meta property="article:tag" content="CKS">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="A basic, security-minded k8s app setup">
<meta name="twitter:description" content="Add a layer of security to your deployment without too much hassle">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/posts/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "A basic, security-minded k8s app setup",
      "item": "/posts/basic-k8s-security/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "A basic, security-minded k8s app setup",
  "name": "A basic, security-minded k8s app setup",
  "description": "Add a layer of security to your deployment without too much hassle",
  "keywords": [
    "k8s", "security", "CKS"
  ],
  "articleBody": "what \u0026 why The CKS (Certified Kubernetes Security Specialist) is a great resource for knowing how to secure a kubernetes cluster. It covers a lot of topics, from the cluster side (admission controller, webhooks, audit), app side (Pod Security Policies) and supply chain (image scanning). Another great resource for this is the Kubernetes Hardening Guidance by NSA \u0026 CISA\nBut some of the concepts defined in both these resources are very case-specific, and require a lot of time, tools \u0026 effort to setup. In some environnements, it might be infeasible to deploy each and every one of those concepts. But that doesn’t mean we should avoid some basic security-minded steps when deploying to k8s. I won’t cover things on the cluster-side (audit, tools like falco, or admission controllers), but how you can improve the security of your front-facing app by adding a few lines here and there.\nhow Let say we have a python app, that exposes an API. We have a basic Dockerfile for it, and a simple deploy.yaml spec file containing our Deployment. They are what you could call ’typical’ of what can be found online when looking for a template of dockerfile or deployment:\nDockerfile:\nFROM python:3-alpine COPY requirements.txt . RUN pip3 install -r requirements.txt WORKDIR /app COPY src/ ./ ENV PYTHONUNBUFFERED 1 CMD python3 app.py deployment manifest:\napiVersion: apps/v1 kind: Deployment metadata: name: api spec: selector: matchLabels: app: api template: metadata: labels: app: api spec: containers: - name: api image: registry/api:latest ports: - containerPort: 5000 Let’s secure things up :\nnon root user The first recommendation is to run our containers as non-root users. For that, we’ll first add a few lines to our Dockerfile:\n... RUN addgroup -S app \u0026\u0026 adduser -H -D -S app -G app -s /dev/null USER app:app WORKDIR /app Note that we are using an alpine-based container, so the exact command might vary on other distros, but the goal is the same\nBy creating a user ‘app’, and using it to run our app, we avoid giving way too much permissions to the app. We can check that by exec’ing into the running container:\n(before)\n/app # id uid=0(root) gid=0(root) groups=1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video) /app # ps PID USER TIME COMMAND 1 root 0:00 {flask-api.py} /usr/local/bin/python3 ./flask-api.py 7 root 0:00 sh 14 root 0:00 ps (now)\n/app $ id uid=101(app) gid=101(app) /app $ ps PID USER TIME COMMAND 1 app 0:00 {flask-api.py} /usr/local/bin/python3 ./flask-api.py 7 app 0:00 sh 14 app 0:00 ps Right, so now we are not running as root on the container side, but what about the host ? To which user are we mapped to on the host side ?\nwhen running the default image:\nk8s-worker \u003e ps -aux | grep flask root 2266529 1.8 0.1 28168 23752 ? Ss 17:31 0:00 /usr/local/bin/python3 ./flask-api.py We are actually mapped to the root user ! that’s not the most secure setup ! If somehow an attacker gain control of the pod and is able to escape, he will land on the host as the root user.\nAnd if we use the new Dockerfile with the USER directive:\nps -aux | grep flask syslog 2267104 2.8 0.1 28168 23812 ? Ss 17:32 0:00 /usr/local/bin/python3 ./flask-api.py What ? Why are we mapped to the syslog user ? A quick check of /etc/passwd shows us why :\ncat /etc/passwd | grep 101 syslog:x:101:107::/home/syslog:/usr/sbin/nologin This is because when we created the user app in the Dockerfile, it assigned to it the uid 101, which is the same as the syslog user on our host.\nTo avoid clashing with a potential user with the same uid on the host, we can use a higher uid, in the 40000-60000 range.\nrunAsUser To fix that, we will tweak our deploy.yaml:\ncontainers: - name: api image: registry/api:latest securityContext: runAsUser: 60096 runAsGroup: 60096 Now, from the host side, we will appear as uid 60096, which isn’t mapped to a predefined user (unless a user with the same uid exists on the host obviously).\nreadOnlyRootFilesystem Another great addition to the Deployment spec, it to set the filesystem as readonly. This will block any attempt to modify the filesystem of the container, like installing binaries, modifying configuration in /etc..\ncontainers: - name: api image: registry/api:latest securityContext: readOnlyRootFilesystem: true runAsUser: 60096 runAsGroup: 60096 Now if we try to change something, we’ll be greeted by an error message, preventing any change on the root fs:\nERROR: Unable to lock database: Read-only file system ERROR: Failed to open apk database: Read-only file system If our app needs to be able to write in a given folder (like a /tmp/cache folder for caching), we can create a volumeMount in the deployment, mapped to an ’emptyDir’. This will allow the app to write at this folder, while retaining the read-only root fs:\ncontainers: - name: api image: registry/api:latest volumeMounts: - mountPath: /tmp/cache name: cache-volume volumes: - name: cache-volume emptyDir: {} automountServiceAccountToken If the pod is not going to communicate with the kubernetes API, we can avoid mounting the service account’s token in the pod (which by default will be mounted in /var/run/secrets/kubernetes.io/serviceaccount/token):\nspec: automountServiceAccountToken: false containers: resources While we’re on the deployment, it’s also a good idea to set some resources limits on the pod. This will prevent the pods from consuming all the resources from the host, which even if it’s from a genuine mistake, can result in outages or other disurptions:\ncontainers: - name: api image: registry/api:latest resources: limits: cpu: 500m memory: 128Mi requests: cpu: 100m memory: 64Mi requests will tell k8s the requirements for the pod, i.e what we can expect the pod to consume. This will aid the scheduling on an appropriate node.\nlimits will actually stop the pod from consuming more than what is specified, either by throttling for the cpu, or OOM for the memory.\nSHA tagging Another recommendation would be to use SHA tagging on the base image of our Dockerfile. This serves two purposes:\nmaking reproducible builds possible. Otherwise, as the base image can be updated, this will break our current setup even though our Dockerfile hasn’t changed. aleviate supply chain attacks: If the base image used is subject to a supply chain attack (a threat actor injects/modify the image), our image becomes subject as well because we’ll pull the latest version of the image. To do so, we simply add the SHA of the image we want to fix at the end of the tag:\nFROM python:3.9-alpine3.15@sha256:f2aeefbeb3846b146a8ad9b995af469d249272af804b309318e2c72c9ca035b0 We can repeat the same behavior on the deployment. Instead of using registry/api:latest, but by using a versionning scheme (like semver or calver) and combining this with the SHA of the image, we ensure that the image used in the deployment will not be updated due to upstream changes.\nResults Final versions of the Dockerfile and deploy.yaml would look like this:\nDockerfile\nFROM python:3.9-alpine3.15@sha256:f2aeefbeb3846b146a8ad9b995af469d249272af804b309318e2c72c9ca035b0 COPY requirements.txt . RUN pip3 install -r requirements.txt RUN addgroup -S app \u0026\u0026 adduser -H -D -S app -G app -s /dev/null USER app:app WORKDIR /app COPY src/ ./ ENV PYTHONUNBUFFERED 1 CMD [\"python3\",\"app.py\"] deploy.yaml\napiVersion: apps/v1 kind: Deployment metadata: name: api spec: selector: matchLabels: app: api template: metadata: labels: app: api spec: automountServiceAccountToken: false containers: - name: api image: registry/api:v1.0.3@sha256:f469d249272af80... securityContext: readOnlyRootFilesystem: true runAsUser: 69096 runAsGroup: 69096 ports: - containerPort: 5000 volumeMounts: - mountPath: /tmp/cache name: cache-volume volumes: - name: cache-volume emptyDir: {} Theses are simples yet effectives ways to secure your app on k8s. If you want to go deeper, I would suggests checking more advanced topics like host-side security (using apparmor profiles for example), falco , or supply chain security (Open Policy Agent, Admission controllers..). Theses are all topics that are covered by the CKS, and with plenty of information online.\nFurther resources https://pwning.systems/posts/escaping-containers-for-fun/ https://kubernetes.io/docs/concepts/storage/volumes/#emptydir https://kubernetes.io/docs/tasks/configure-pod-container/security-context/ ",
  "wordCount" : "1280",
  "inLanguage": "en",
  "datePublished": "2022-03-09T00:00:00Z",
  "dateModified": "2022-03-09T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/posts/basic-k8s-security/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "k0rventen's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="&gt; k0rventen: ~ (Alt + H)">&gt; k0rventen: ~</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="/links" title="links">
                    <span>links</span>
                </a>
            </li>
            <li>
                <a href="/posts" title="posts">
                    <span>posts</span>
                </a>
            </li>
            <li>
                <a href="/search" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      A basic, security-minded k8s app setup
    </h1>
    <div class="post-description">
      Add a layer of security to your deployment without too much hassle
    </div>
    <div class="post-meta"><span title='2022-03-09 00:00:00 +0000 UTC'>March 9, 2022</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1280 words

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#what--why">what &amp; why</a></li>
    <li><a href="#how">how</a>
      <ul>
        <li><a href="#non-root-user">non root user</a></li>
        <li><a href="#runasuser">runAsUser</a></li>
        <li><a href="#readonlyrootfilesystem">readOnlyRootFilesystem</a></li>
        <li><a href="#automountserviceaccounttoken">automountServiceAccountToken</a></li>
        <li><a href="#resources">resources</a></li>
        <li><a href="#sha-tagging">SHA tagging</a></li>
        <li><a href="#results">Results</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="what--why">what &amp; why<a hidden class="anchor" aria-hidden="true" href="#what--why">#</a></h2>
<p>The CKS (Certified Kubernetes Security Specialist) is a great resource for knowing how to secure a kubernetes cluster.
It covers a lot of topics, from the cluster side (admission controller, webhooks, audit), app side (Pod Security Policies) and supply chain (image scanning). Another great resource for this is the <a href="https://media.defense.gov/2021/Aug/03/2002820425/-1/-1/1/CTR_KUBERNETESHARDENINGGUIDANCE.PDF">Kubernetes Hardening Guidance by NSA &amp; CISA</a></p>
<p>But some of the concepts defined in both these resources are very case-specific, and require a lot of time, tools &amp; effort to setup. In some environnements, it might be infeasible to deploy each and every one of those concepts. But that doesn&rsquo;t mean we should avoid some basic security-minded steps when deploying to k8s. I won&rsquo;t cover things on the cluster-side (audit, tools like falco, or admission controllers), but how you can improve the security of your front-facing app by adding a few lines here and there.</p>
<h2 id="how">how<a hidden class="anchor" aria-hidden="true" href="#how">#</a></h2>
<p>Let say we have a python app, that exposes an API. We have a basic Dockerfile for it, and a simple <code>deploy.yaml</code> spec file containing our Deployment. They are what you could call &rsquo;typical&rsquo; of what can be found online when looking for a template of dockerfile or deployment:</p>
<p>Dockerfile:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> python:3-alpine</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> requirements.txt .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip3 install -r requirements.txt<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> src/ ./<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> PYTHONUNBUFFERED <span class="m">1</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> python3 app.py<span class="err">
</span></span></span></code></pre></div><p>deployment manifest:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry/api:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">5000</span><span class="w">
</span></span></span></code></pre></div><p>Let&rsquo;s secure things up :</p>
<h3 id="non-root-user">non root user<a hidden class="anchor" aria-hidden="true" href="#non-root-user">#</a></h3>
<p>The first recommendation is to run our containers as non-root users. For that, we&rsquo;ll first add a few lines to our Dockerfile:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl">...<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> addgroup -S app <span class="o">&amp;&amp;</span> adduser -H -D -S app -G app -s /dev/null<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">USER</span><span class="s"> app:app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /app</span><span class="err">
</span></span></span></code></pre></div><p><strong>Note that we are using an alpine-based container, so the exact command might vary on other distros, but the goal is the same</strong></p>
<p>By creating a user &lsquo;app&rsquo;, and using it to run our app, we avoid giving <em>way too much</em> permissions to the app.
We can check that by exec&rsquo;ing into the running container:</p>
<p>(before)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">/app <span class="c1"># id</span>
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1<span class="o">(</span>bin<span class="o">)</span>,2<span class="o">(</span>daemon<span class="o">)</span>,3<span class="o">(</span>sys<span class="o">)</span>,4<span class="o">(</span>adm<span class="o">)</span>,6<span class="o">(</span>disk<span class="o">)</span>,10<span class="o">(</span>wheel<span class="o">)</span>,11<span class="o">(</span>floppy<span class="o">)</span>,20<span class="o">(</span>dialout<span class="o">)</span>,26<span class="o">(</span>tape<span class="o">)</span>,27<span class="o">(</span>video<span class="o">)</span>
</span></span><span class="line"><span class="cl">/app <span class="c1"># ps</span>
</span></span><span class="line"><span class="cl">PID   USER     TIME  COMMAND
</span></span><span class="line"><span class="cl">    <span class="m">1</span> root      0:00 <span class="o">{</span>flask-api.py<span class="o">}</span> /usr/local/bin/python3 ./flask-api.py
</span></span><span class="line"><span class="cl">    <span class="m">7</span> root      0:00 sh
</span></span><span class="line"><span class="cl">   <span class="m">14</span> root      0:00 ps
</span></span></code></pre></div><p>(now)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">/app $ id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>101<span class="o">(</span>app<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>101<span class="o">(</span>app<span class="o">)</span>
</span></span><span class="line"><span class="cl">/app $ ps
</span></span><span class="line"><span class="cl">PID   USER     TIME  COMMAND
</span></span><span class="line"><span class="cl">    <span class="m">1</span> app       0:00 <span class="o">{</span>flask-api.py<span class="o">}</span> /usr/local/bin/python3 ./flask-api.py
</span></span><span class="line"><span class="cl">    <span class="m">7</span> app       0:00 sh
</span></span><span class="line"><span class="cl">   <span class="m">14</span> app       0:00 ps
</span></span></code></pre></div><p>Right, so now we are not running as root on the container side, but what about the host ? To which user are we mapped to on the host side ?</p>
<p>when running the default image:</p>
<pre tabindex="0"><code>k8s-worker &gt; ps -aux | grep flask
root     2266529  1.8  0.1  28168 23752 ?        Ss   17:31   0:00 /usr/local/bin/python3 ./flask-api.py
</code></pre><p>We are actually mapped to the root user ! that&rsquo;s not the most secure setup ! If somehow an attacker gain control of the pod and is able to escape, he will land on the host as the root user.</p>
<p>And if we use the new Dockerfile with the USER directive:</p>
<pre tabindex="0"><code>ps -aux | grep flask
syslog   2267104  2.8  0.1  28168 23812 ?        Ss   17:32   0:00 /usr/local/bin/python3 ./flask-api.py
</code></pre><p>What ? Why are we mapped to the syslog user ? A quick check of <em>/etc/passwd</em> shows us why :</p>
<pre tabindex="0"><code>cat /etc/passwd | grep 101
syslog:x:101:107::/home/syslog:/usr/sbin/nologin
</code></pre><p>This is because when we created the user <code>app</code> in the Dockerfile, it assigned to it the uid 101, which is the same as the syslog user on our host.</p>
<p>To avoid clashing with a potential user with the same uid on the host, we can use a higher uid, in the <code>40000-60000</code> range.</p>
<h3 id="runasuser">runAsUser<a hidden class="anchor" aria-hidden="true" href="#runasuser">#</a></h3>
<p>To fix that, we will tweak our <code>deploy.yaml</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry/api:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">60096</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="m">60096</span><span class="w">
</span></span></span></code></pre></div><p>Now, from the host side, we will appear as uid <code>60096</code>, which isn&rsquo;t mapped to a predefined user (unless a user with the same uid exists on the host obviously).</p>
<h3 id="readonlyrootfilesystem">readOnlyRootFilesystem<a hidden class="anchor" aria-hidden="true" href="#readonlyrootfilesystem">#</a></h3>
<p>Another great addition to the Deployment spec, it to set the filesystem as readonly.
This will block any attempt to modify the filesystem of the container, like installing binaries, modifying configuration in /etc..</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry/api:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">readOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">60096</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="m">60096</span><span class="w">
</span></span></span></code></pre></div><p>Now if we try to change something, we&rsquo;ll be greeted by an error message, preventing any change on the root fs:</p>
<pre tabindex="0"><code>ERROR: Unable to lock database: Read-only file system
ERROR: Failed to open apk database: Read-only file system
</code></pre><p>If our app needs to be able to write in a given folder (like a /tmp/cache folder for caching), we can create a volumeMount in the deployment, mapped to an &rsquo;emptyDir&rsquo;. This will allow the app to write at this folder, while retaining the read-only root fs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry/api:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp/cache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cache-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cache-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></div><h3 id="automountserviceaccounttoken">automountServiceAccountToken<a hidden class="anchor" aria-hidden="true" href="#automountserviceaccounttoken">#</a></h3>
<p>If the pod is not going to communicate with the kubernetes API, we can avoid mounting the service account&rsquo;s token in the pod (which by default will be mounted in <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">automountServiceAccountToken</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span></code></pre></div><h3 id="resources">resources<a hidden class="anchor" aria-hidden="true" href="#resources">#</a></h3>
<p>While we&rsquo;re on the deployment, it&rsquo;s also a good idea to set some resources limits on the pod. This will prevent the pods from consuming all the resources from the host, which even if it&rsquo;s from a genuine mistake, can result in outages or other disurptions:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry/api:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">500m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">64Mi</span><span class="w">
</span></span></span></code></pre></div><p><code>requests</code> will tell k8s the requirements for the pod, i.e what we can expect the pod to consume. This will aid the scheduling on an appropriate node.</p>
<p><code>limits</code> will actually stop the pod from consuming more than what is specified, either by throttling for the cpu, or OOM for the memory.</p>
<h3 id="sha-tagging">SHA tagging<a hidden class="anchor" aria-hidden="true" href="#sha-tagging">#</a></h3>
<p>Another recommendation would be to use SHA tagging on the base image of our Dockerfile. This serves two purposes:</p>
<ul>
<li>making reproducible builds possible. Otherwise, as the base image can be updated, this will break our current setup even though our Dockerfile hasn&rsquo;t changed.</li>
<li>aleviate supply chain attacks: If the base image used is subject to a supply chain attack (a threat actor injects/modify the image), our image becomes subject as well because we&rsquo;ll pull the latest version of the image.</li>
</ul>
<p>To do so, we simply add the SHA of the image we want to fix at the end of the tag:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> python:3.9-alpine3.15@sha256:f2aeefbeb3846b146a8ad9b995af469d249272af804b309318e2c72c9ca035b0</span><span class="err">
</span></span></span></code></pre></div><p>We can repeat the same behavior on the deployment. Instead of using <code>registry/api:latest</code>, but by using a versionning scheme (like <a href="https://semver.org/">semver</a> or <a href="https://calver.org/">calver</a>) and combining this with the SHA of the image, we ensure that the image used in the deployment will not be updated due to upstream changes.</p>
<h3 id="results">Results<a hidden class="anchor" aria-hidden="true" href="#results">#</a></h3>
<p>Final versions of the Dockerfile and deploy.yaml would look like this:</p>
<p>Dockerfile</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> python:3.9-alpine3.15@sha256:f2aeefbeb3846b146a8ad9b995af469d249272af804b309318e2c72c9ca035b0</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> requirements.txt .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip3 install -r requirements.txt<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> addgroup -S app <span class="o">&amp;&amp;</span> adduser -H -D -S app -G app -s /dev/null<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">USER</span><span class="s"> app:app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> src/ ./<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> PYTHONUNBUFFERED <span class="m">1</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;python3&#34;</span><span class="p">,</span><span class="s2">&#34;app.py&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></div><p>deploy.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">automountServiceAccountToken</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry/api:v1.0.3@sha256:f469d249272af80...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">readOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">69096</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="m">69096</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">5000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp/cache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cache-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cache-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></div><p>Theses are simples yet effectives ways to secure your app on k8s. If you want to go deeper, I would suggests checking more advanced topics like host-side security (using apparmor profiles for example), falco , or supply chain security (Open Policy Agent, Admission controllers..). Theses are all topics that are covered by the CKS, and with plenty of information online.</p>
<h1 id="further-resources">Further resources<a hidden class="anchor" aria-hidden="true" href="#further-resources">#</a></h1>
<ul>
<li><a href="https://pwning.systems/posts/escaping-containers-for-fun/">https://pwning.systems/posts/escaping-containers-for-fun/</a></li>
<li><a href="https://kubernetes.io/docs/concepts/storage/volumes/#emptydir">https://kubernetes.io/docs/concepts/storage/volumes/#emptydir</a></li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">https://kubernetes.io/docs/tasks/configure-pod-container/security-context/</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/k8s/">K8s</a></li>
      <li><a href="/tags/security/">Security</a></li>
      <li><a href="/tags/cks/">CKS</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="/posts/keda-autoscaling/">
    <span class="title">« Prev</span>
    <br>
    <span>Autoscaling using KEDA</span>
  </a>
  <a class="next" href="/posts/remote-mulituser-vscode-kubernetes/">
    <span class="title">Next »</span>
    <br>
    <span>Remote, multi-user VSCode running in kubernetes</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="/">k0rventen&#39;s blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
