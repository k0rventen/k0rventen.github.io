<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>A Monkey in the Cluster | k0rventen&#39;s blog</title>
<meta name="keywords" content="k8s, chaos-engineering">
<meta name="description" content="apply the Chaos Engineering principles to k8s">
<meta name="author" content="">
<link rel="canonical" href="/posts/a-monkey-in-the-cluster/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="/posts/a-monkey-in-the-cluster/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="/posts/a-monkey-in-the-cluster/">
  <meta property="og:site_name" content="k0rventen&#39;s blog">
  <meta property="og:title" content="A Monkey in the Cluster">
  <meta property="og:description" content="apply the Chaos Engineering principles to k8s">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-08-11T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-08-11T00:00:00+00:00">
    <meta property="article:tag" content="K8s">
    <meta property="article:tag" content="Chaos-Engineering">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="A Monkey in the Cluster">
<meta name="twitter:description" content="apply the Chaos Engineering principles to k8s">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/posts/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "A Monkey in the Cluster",
      "item": "/posts/a-monkey-in-the-cluster/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "A Monkey in the Cluster",
  "name": "A Monkey in the Cluster",
  "description": "apply the Chaos Engineering principles to k8s",
  "keywords": [
    "k8s", "chaos-engineering"
  ],
  "articleBody": "what \u0026 why From principlesofchaos.org :\nAdvances in large-scale, distributed software systems are changing the game for software engineering. As an industry, we are quick to adopt practices that increase flexibility of development and velocity of deployment. An urgent question follows on the heels of these benefits: How much confidence we can have in the complex systems that we put into production?\nApplying this philosophy to kube is a very pertinent thing to do, but how ? The same website defines Chaos Engineering as the discipline of experimenting on a system in order to build confidence in the system’s capability to withstand turbulent conditions in production.\nSo, let’s introduce turbulences in our cluster.\nNetflix developed their Chaos Monkey a while back, and this is basically the same thing, applied to kubernetes concepts.\nA monkey, in the cluster, breaking things. The easiest route for this is attacking the primary Kube resource, pods. Let’s terminate some random pods and see what happens.\nWe are sure that kubernetes will restart our pods if we have defined any kind of top level management over them (such as deployments, daemonsets, etc..). Killing a pod is about testing whether our application can withstand it.\nhow This is also my first real golang project, using some of the language’s specific features about concurrency (go routines, channels) and structs.\nThe project is made of 3 go routines, each communicating with the other using channels. The configuration is handled through a struct.\nThe main routine is a simple sleeps until the next cron occurence, notify the killer routine, repeat loop. The killer routine waits for a message from the main routine, then list pods that match the criterias, select one of them and terminate it, and sends a message to the slack routine about what happened. the slack routine, which waits for a message and simply transmits the message to the channel (if any). This might not be the simplest approach, as a simple sleep-\u003ekill-\u003emessage-\u003eloop would have sufficed, but this is also about learning the ins-and-outs of the language.\nthe project is hosted here, and can be deployed on any cluster in 3 commands:\n# download the spec file curl -LO https://raw.githubusercontent.com/k0rventen/macaque/main/macaque.yml # edit the env vars to match your config $EDITOR macaque.yml # apply (make sure you are in the right ns) kubectl apply -f macaque.yml The containers are available for both amd64 and arm64. The RBAC configuration is included in the spec file, the pod needs list and delete of the pods resource in the current namespace.\nThe configuration is done through env var. You must specify the crontab spec and the namespace in which to kill pods, and you can add a label selector to narrow the targets, add a slack token and channel ID to be informed when the monkey does things.\n",
  "wordCount" : "467",
  "inLanguage": "en",
  "datePublished": "2021-08-11T00:00:00Z",
  "dateModified": "2021-08-11T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/posts/a-monkey-in-the-cluster/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "k0rventen's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="&gt; k0rventen: ~ (Alt + H)">&gt; k0rventen: ~</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="/links" title="links">
                    <span>links</span>
                </a>
            </li>
            <li>
                <a href="/posts" title="posts">
                    <span>posts</span>
                </a>
            </li>
            <li>
                <a href="/search" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      A Monkey in the Cluster
    </h1>
    <div class="post-description">
      apply the Chaos Engineering principles to k8s
    </div>
    <div class="post-meta"><span title='2021-08-11 00:00:00 +0000 UTC'>August 11, 2021</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;467 words

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#what--why">what &amp; why</a></li>
    <li><a href="#how">how</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="what--why">what &amp; why<a hidden class="anchor" aria-hidden="true" href="#what--why">#</a></h2>
<p>From <a href="https://principlesofchaos.org">principlesofchaos.org</a> :</p>
<p><em>Advances in large-scale, distributed software systems are changing the game for software engineering. As an industry, we are quick to adopt practices that increase flexibility of development and velocity of deployment. An urgent question follows on the heels of these benefits: How much confidence we can have in the complex systems that we put into production?</em></p>
<p>Applying this philosophy to kube is a very pertinent thing to do, but how ? The same website defines Chaos Engineering as <em>the discipline of experimenting on a system in order to build confidence in the system’s capability to withstand turbulent conditions in production.</em></p>
<p>So, let&rsquo;s introduce <em>turbulences</em> in our cluster.</p>
<p>Netflix developed their <a href="https://netflix.github.io/chaosmonkey/">Chaos Monkey</a> a while back, and this is basically the same thing, applied to kubernetes concepts.</p>
<p>A monkey, in the cluster, breaking things. The easiest route for this is attacking the primary Kube resource, pods. Let&rsquo;s terminate some random pods and see what happens.</p>
<p>We are sure that kubernetes <strong>will</strong> restart our pods if we have defined any kind of top level management over them (such as deployments, daemonsets, etc..). Killing a pod is about testing whether our application can withstand it.</p>
<h2 id="how">how<a hidden class="anchor" aria-hidden="true" href="#how">#</a></h2>
<p>This is also my first <em>real</em> golang project, using some of the language&rsquo;s specific features about concurrency (go routines, channels) and structs.</p>
<p>The project is made of 3 go routines, each communicating with the other using channels. The configuration is handled through a struct.</p>
<ul>
<li>The main routine is a simple <em>sleeps until the next cron occurence, notify the killer routine, repeat</em> loop.</li>
<li>The killer routine waits for a message from the main routine, then list pods that match the criterias, select one of them and terminate it, and sends a message to the slack routine about what happened.</li>
<li>the slack routine, which waits for a message and simply transmits the message to the channel (if any).</li>
</ul>
<p>This might not be the simplest approach, as a simple sleep-&gt;kill-&gt;message-&gt;loop would have sufficed, but this is also about learning the ins-and-outs of the language.</p>
<p>the project is hosted <a href="https://github.com/k0rventen/macaque">here</a>, and can be deployed on any cluster in 3 commands:</p>
<pre tabindex="0"><code># download the spec file
curl -LO https://raw.githubusercontent.com/k0rventen/macaque/main/macaque.yml

# edit the env vars to match your config
$EDITOR macaque.yml

# apply (make sure you are in the right ns)
kubectl apply -f macaque.yml
</code></pre><p>The containers are available for both <code>amd64</code> and <code>arm64</code>. The RBAC configuration is included in the spec file, the pod needs <em>list</em> and <em>delete</em> of the <strong>pods</strong> resource in the current namespace.</p>
<p>The configuration is done through env var. You <em>must</em> specify the crontab spec and the namespace in which to kill pods, and you <em>can</em> add a label selector to narrow the targets, add a slack token and channel ID to be informed when the monkey does things.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/k8s/">K8s</a></li>
      <li><a href="/tags/chaos-engineering/">Chaos-Engineering</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="/posts/reducing-docker-images-size-using-xz/">
    <span class="title">« Prev</span>
    <br>
    <span>Reducing Docker Images Size Using Xz</span>
  </a>
  <a class="next" href="/posts/kube-hpa/">
    <span class="title">Next »</span>
    <br>
    <span>Exploring Kube&#39;s Horizontal Pod Autoscaler</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="/">k0rventen&#39;s blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
