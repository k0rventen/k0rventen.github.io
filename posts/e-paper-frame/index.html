<!doctype html><html lang=en><head><title>E Ink Message frame ::
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Transmit paper-like messages from 18000 kms away:
A simple, e-ink display that receives messages from loved ones from the other side of the globe.
why About 10 months ago, my sister left our country to do a WHP (Work-Holiday-Program) on the other side of the world (fun fact, this is almost true as the antipodes of France where we live is right next to New-Zealand, where my sister went).
Going far today isn&amp;rsquo;t as bad as it would have been decades ago, we have messages, video calling and other new mediums that can bring people closer together even far away."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/e-paper-frame/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="E Ink Message frame"><meta name=twitter:description content="Transmit paper-like messages from 18000 kms away"><meta property="og:title" content="E Ink Message frame"><meta property="og:description" content="Transmit paper-like messages from 18000 kms away"><meta property="og:type" content="article"><meta property="og:url" content="/posts/e-paper-frame/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-27T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-27T00:00:00+00:00"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>k0rventen:~</span>
<span class=logo__cursor></span>
</a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/links>links</a></li><li><a href=/manpage>manpage</a></li><li><a href=/>posts</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/links>links</a></li><li><a href=/manpage>manpage</a></li><li><a href=/>posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>E Ink Message frame</h1><div class=post-meta><span class=post-date>2024-05-27
</span><span class=post-read-time>— 7 min read</span></div><span class=post-tags><a href=/tags/raspberrypi/>#raspberrypi</a>&nbsp;
<a href=/tags/e-ink/>#e-ink</a>&nbsp;
<a href=/tags/tailscale/>#tailscale</a>&nbsp;
<a href=/tags/python/>#python</a>&nbsp;</span><div class=post-content><h2>Table of Contents</h2><aside class=table-of-contents><nav id=TableOfContents><ul><li><a href=#why>why</a></li><li><a href=#how>how</a><ul><li><a href=#the-box>The box</a></li><li><a href=#the-software>the software</a><ul><li><a href=#the-frontend>the frontend</a></li><li><a href=#the-server>the server</a></li><li><a href=#the-network>the network</a></li><li><a href=#the-display>the display</a></li></ul></li></ul></li><li><a href=#how-it-turned-out>how it turned out</a></li></ul></nav></aside><p>Transmit paper-like messages from 18000 kms away:</p><p>A simple, e-ink display that receives messages from loved ones from the other side of the globe.</p><p><img src=/e-paper-display/result.png alt></p><h1 id=why>why</h1><p>About 10 months ago, my sister left our country to do a WHP (Work-Holiday-Program) on the other side of the world (fun fact, this is almost true as the antipodes of France where we live is right next to New-Zealand, where my sister went).</p><p>Going far today isn&rsquo;t as bad as it would have been decades ago, we have messages, video calling and other new mediums that can bring people closer together even far away. This was important for all of us to still be able to connect, but I guess even more for my parents. So a few months in, I decided to create something different for them to know what she was up to, without needing their phones.</p><p>The idea came after seeing the <a href=https://www.kickstarter.com/projects/genmon/poem-1-the-ai-poetry-clock>Poem 1 concept</a>, which is a &lsquo;clock&rsquo;, powered by ChatGPT and using a e-ink display. I I thought to myself that this form-factor and display could be a nice way of displaying messages from my sister. They wouldn&rsquo;t diseappear, always readable from anywhere in a room.</p><p>So the goal was set: My sister would be able to send messages to the e-ink box at my parent&rsquo;s, which would display them on the e-ink screen. How hard could it be ?</p><h1 id=how>how</h1><p>This project is made of various pieces:</p><ul><li>the physical &lsquo;box&rsquo; that will be at my parent&rsquo;s, receiving messages from a server and displaying them</li><li>a server, that will let clients send messages through a simple front end</li><li>a way for clients to connect to the server from anywhere in the world</li></ul><h2 id=the-box>The box</h2><p>The first order of business was to find an E-ink display that would fit my requirements. I settled on a 4.2" unit from Waveshare: <a href=https://www.waveshare.com/4.2inch-e-paper-module.htm>https://www.waveshare.com/4.2inch-e-paper-module.htm</a></p><p>The SPI interface would be controlled through a Raspberry Pi Zero W.</p><p>I then designed a 3D printed case that would fit the two components. As I don&rsquo;t know anything about CAD design tools, I fiddled with Tinkercad until I had something that was both printable and not too ugly (I discovered why beveled and rounded edges are everywhere after printing my first &lsquo;cubic&rsquo; version).</p><p><img src=/e-paper-display/frame.png alt></p><p>I then &lsquo;assembled&rsquo; everything:</p><ul><li>soldered the wires from the display PCB to the pi W,</li><li>fitted the display and pi inside the box (read double sided tape and hot glue)</li></ul><p>Here is what it looks like inside:</p><p><img src=/e-paper-display/inside-box.jpeg alt></p><p>After some sanding of the exterior of the box, it has quite a nice finish to it and looks decent enough:</p><video class=video-shortcode preload=auto controls autoplay>
<source src=/e-paper-display/box.mp4 type=video/mp4>There should have been a video here but your browser does not seem to support it.</video><p>Now that we have a working physical thing, onto the software !</p><h2 id=the-software>the software</h2><p>There&rsquo;s multiple facets to consider:</p><ul><li>clients that should be able to send messages easily to a server</li><li>the server that would store the messages (and pictures, because I decided mid-project that sending pictures to the display would be fun)</li><li>the logic to display nicely the message and when it was sent on the display.</li></ul><h3 id=the-frontend>the frontend</h3><p>The first part was a nice challenge. I&rsquo;m not a frontend engineer, and have very limited design abilities (as seen previously on the box&rsquo;s design).
I decided that the frontend would be entirely developed (ie the code) by chatGPT. I wanted to see if it was possible to create the whole frontend design and logic using only AI. The features of the frontend would be as follows:</p><ul><li>authenticate using basic auth</li><li>a simple form to send a new message/image</li><li>display the list of previouly sent messages</li></ul><p>Here is the first message of a long conversation between me and chatGPT:</p><p><img src=/e-paper-display/chatgpt.png alt></p><p>We then refined the UI, implemented the various features (when I say we, I mean I expressed what I wanted, or wrote feedback on the previous iteration).</p><p>Here is a quick list of features that chatGPT implemented on its own:</p><ul><li>all the design, including the nice background gradient</li><li>handling the requests to the backend server</li><li>displaying the previous messages from a GET endpoint</li><li>Adding support for uploading images</li><li>the little character counter next to the input</li></ul><p>The only feature that it wasn&rsquo;t able to code properly is the button for removing the selected image.</p><p>Finally, here is what the UI looks like on a phone :</p><p><img src=/e-paper-display/screen.png alt></p><p>I would say that 95% of the code was written by gpt, and a few tweaks and corrections by me.
Obviously it&rsquo;s quite a simple use-case, but it delivered something I would have spent 3 weeks dealing with CSS centering.</p><p>10/10 experience.</p><h3 id=the-server>the server</h3><p>So this frontend talks to a python backend. Nothing fancy. The data is stored using tinyDB, as an array:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>    <span style=color:#e6db74>&#34;32&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;timestamp&#34;</span>: <span style=color:#ae81ff>1711017153</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;user&#34;</span>: <span style=color:#e6db74>&#34;mel&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;display&#34;</span>: <span style=color:#e6db74>&#34;8b74c00a-1093-41da-89ad-a17aabcbbf98&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;\u00e7a apprend \u00e0 surfer par ici \ud83c\udfc4\u200d\u2640\ufe0f&#34;</span>
</span></span><span style=display:flex><span>    }<span style=color:#960050;background-color:#1e0010>,</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;33&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;timestamp&#34;</span>: <span style=color:#ae81ff>1711513109</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;user&#34;</span>: <span style=color:#e6db74>&#34;mel&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;display&#34;</span>: <span style=color:#e6db74>&#34;8b74c00a-1093-41da-89ad-a17aabcbbf98&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;jour 190 - je quitte Mirissa et retourne \u00e0 Weligama! \ud83c\udf0a&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Creating a new message is a POST request.
We grab the username, timestamp, message/image, create a UUID for the image and stores it locally.
The convert/thumbnail is here to format the image to be then displayed on the e-ink screen.
You can imagine the GET endpoint for the display, it&rsquo;s simply returning the last entry of the messages.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@api.post</span>(<span style=color:#e6db74>&#34;/messages&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>new_message</span>(resp: Response,request:Request,user<span style=color:#f92672>=</span> Depends(auth_check)):
</span></span><span style=display:flex><span>    form <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> request<span style=color:#f92672>.</span>form()
</span></span><span style=display:flex><span>    msg <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;timestamp&#34;</span>:int(time()),<span style=color:#e6db74>&#34;user&#34;</span>:user}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> img <span style=color:#f92672>:=</span> form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;image&#34;</span>):
</span></span><span style=display:flex><span>        im <span style=color:#f92672>=</span> Image<span style=color:#f92672>.</span>open(BytesIO(img<span style=color:#f92672>.</span>file<span style=color:#f92672>.</span>read()))
</span></span><span style=display:flex><span>        image <span style=color:#f92672>=</span> im<span style=color:#f92672>.</span>convert(<span style=color:#e6db74>&#34;L&#34;</span>)
</span></span><span style=display:flex><span>        image<span style=color:#f92672>.</span>thumbnail((<span style=color:#ae81ff>368</span>,<span style=color:#ae81ff>200</span>))
</span></span><span style=display:flex><span>        im_uuid <span style=color:#f92672>=</span> str(uuid4())
</span></span><span style=display:flex><span>        image<span style=color:#f92672>.</span>save(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;./static/imgs/</span><span style=color:#e6db74>{</span>im_uuid<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg&#34;</span>)
</span></span><span style=display:flex><span>        msg[<span style=color:#e6db74>&#34;image&#34;</span>] <span style=color:#f92672>=</span> im_uuid
</span></span><span style=display:flex><span>        msg[<span style=color:#e6db74>&#34;message&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;image&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> message <span style=color:#f92672>:=</span> form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;message&#34;</span>):
</span></span><span style=display:flex><span>        msg[<span style=color:#e6db74>&#34;message&#34;</span>] <span style=color:#f92672>=</span> message
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    messages<span style=color:#f92672>.</span>insert(msg)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;ok&#34;</span>
</span></span></code></pre></div><h3 id=the-network>the network</h3><p>Ok so we have clients, a server, and a display, all on different part of the world. The clients are roaming (mainly my sister across the globe), the server is on my rasberry pi at home, and the display is at my parent&rsquo;s. I almost went the cloud way, with a hosted, public server, but that would mean spending time to enhance the app&rsquo;s security, setting up proper auth, etc etc. Quite a hassle for this. So I decided to put <a href=https://tailscale.com/>tailscale</a> to the test. It&rsquo;s a mesh VPN that allows peers to connect to each other directly using p2p tunnels.</p><p>All of the clients would have tailscale installed, configured to be on my tailnet, and rules configured to that my sister&rsquo;s phone and the display could talk to the server. Each of them have a static IP in this subnet</p><p>This would then look like this:</p><p><img src=/e-paper-display/network.png alt></p><p>Now, both my sister&rsquo;s phone and the display can access the frontend exposed by my server, without having to expose it publicly. My sister &lsquo;only&rsquo; have to remember to turn on the VPN whenever she wants to send a message.</p><h3 id=the-display>the display</h3><p>On the display side, it&rsquo;s a simple while loop:</p><ul><li>fetch the API for the latest message</li><li>sleep like 10 minutes</li></ul><p>Again, nothing fancy. Doesn&rsquo;t matter if the message isn&rsquo;t received instantaneously:</p><p>The library for controlling the actual display (<a href=https://github.com/waveshareteam/e-Paper>https://github.com/waveshareteam/e-Paper</a>) is quite well made. But for some reason the packaging was broken, so I downloaded the package and included it like this <code>waveshare-epaper @ file:///app/waveshare_epaper-1.3.0-py3-none-any.whl</code> in my requirements.</p><p>Another hurdle I encountered was figuring out how to wrap properly the message if it was too long for a single line. But that has more to do with the font that I used being clearly not monospaced. Fiddling around with arbitrary values to find the exact number of pixels are needed to space things around is always fun !</p><p>What&rsquo;s interesting here it that the lib is Pillow based, meaning you construct your image then sends it to the display:</p><p><em>(you can see my experiment with dark/light mode)</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>refresh_display</span>(user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>,date<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>,content<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,dark_theme<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>):
</span></span><span style=display:flex><span>    bg_color <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>if</span> dark_theme <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>255</span>
</span></span><span style=display:flex><span>    color <span style=color:#f92672>=</span> <span style=color:#ae81ff>255</span> <span style=color:#66d9ef>if</span> dark_theme <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Limage <span style=color:#f92672>=</span> Image<span style=color:#f92672>.</span>new(<span style=color:#e6db74>&#39;1&#39;</span>, (epd<span style=color:#f92672>.</span>width,epd<span style=color:#f92672>.</span>height), bg_color) 
</span></span><span style=display:flex><span>    draw <span style=color:#f92672>=</span> ImageDraw<span style=color:#f92672>.</span>Draw(Limage)
</span></span><span style=display:flex><span>    epd<span style=color:#f92672>.</span>display_Partial(epd<span style=color:#f92672>.</span>getbuffer(Limage))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># blank bg</span>
</span></span><span style=display:flex><span>    draw<span style=color:#f92672>.</span>rectangle((<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, epd<span style=color:#f92672>.</span>width,epd<span style=color:#f92672>.</span>height), fill <span style=color:#f92672>=</span> bg_color)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># from</span>
</span></span><span style=display:flex><span>    draw<span style=color:#f92672>.</span>text((<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>20</span>), user, font <span style=color:#f92672>=</span> font_35,fill <span style=color:#f92672>=</span> color)
</span></span><span style=display:flex><span>    draw<span style=color:#f92672>.</span>text((<span style=color:#ae81ff>12</span>,<span style=color:#ae81ff>50</span>),date,font <span style=color:#f92672>=</span> font_35, fill <span style=color:#f92672>=</span> color)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> isinstance(content,Image<span style=color:#f92672>.</span>Image):
</span></span><span style=display:flex><span>        img_w, _ <span style=color:#f92672>=</span> content<span style=color:#f92672>.</span>size
</span></span><span style=display:flex><span>        img_x <span style=color:#f92672>=</span> int((<span style=color:#ae81ff>400</span> <span style=color:#f92672>-</span> img_w)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>        Limage<span style=color:#f92672>.</span>paste(content, (img_x,<span style=color:#ae81ff>100</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elif</span> isinstance(content,str):
</span></span><span style=display:flex><span>        <span style=color:#75715e># message </span>
</span></span><span style=display:flex><span>        line_start_y,line_height <span style=color:#f92672>=</span> <span style=color:#ae81ff>120</span>,<span style=color:#ae81ff>40</span>
</span></span><span style=display:flex><span>        lines <span style=color:#f92672>=</span> textwrap<span style=color:#f92672>.</span>wrap(content, <span style=color:#ae81ff>18</span>,max_lines<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> i,l <span style=color:#f92672>in</span> enumerate(lines):
</span></span><span style=display:flex><span>            draw<span style=color:#f92672>.</span>text((<span style=color:#ae81ff>12</span>, line_start_y<span style=color:#f92672>+</span>i<span style=color:#f92672>*</span>line_height), l, font <span style=color:#f92672>=</span> font_50, fill <span style=color:#f92672>=</span> color)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    epd<span style=color:#f92672>.</span>display_Partial(epd<span style=color:#f92672>.</span>getbuffer(Limage))
</span></span></code></pre></div><p>I played around with various refreshes, because e-ink displays can partially refresh (change only the pixels that changed) or a full (clearing the screen in-between).
The partial is quicker, but overtime ghosts of previous images can be visible. So a full refresh is done once in a while.</p><p>For the date on top the messages, I used the <a href=https://pypi.org/project/humanize/>humanize</a> lib to convert epoch timestamps to human-friendly format in French.</p><h1 id=how-it-turned-out>how it turned out</h1><p>Again, here is the final result:</p><p><img src=/e-paper-display/result.png alt></p><p>Quite pleased with this one. Mixing hardware and software always hits different, and &lsquo;seeing&rsquo; messages being sent literaly across the globe has a very satisfying taste to it.</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/tesla-lock-sounds/><span class=button__icon>←</span>
<span class=button__text>Randomized Tesla Lock Sounds using a Pi</span>
</a></span><span class="button next"><a href=/posts/lvm-resize/><span class=button__text>How to resize an LVM ext4 partition (and also non-LVM because old VMs)</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>k0rventen:~</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>