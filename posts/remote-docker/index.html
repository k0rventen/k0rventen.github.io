<!doctype html><html lang=en>
<head>
<title>
Remote Docker ::
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="what &amp;amp; why If you want to control a docker instance (the docker daemon) which is not your machine, you can expose it as a TCP socket (instead of a traditionnal UNIX socket) and connect to it remotely using the docker client. We&amp;rsquo;ll also use SSH forwarding to secure the connection to the docker api if security is a concern.
how Install docker
curl -fsSL https://get.docker.com | sh sudo usermod -aG docker $USER then edit the systemd service unit by adding the -H tcp://0.">
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=/posts/remote-docker/>
<link rel=stylesheet href=/assets/style.css>
<link rel=stylesheet href=/style.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=/img/favicon.png>
<link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Remote Docker">
<meta name=twitter:description content="using a TCP & UNIX sockets and SSH forwarding">
<meta property="og:title" content="Remote Docker">
<meta property="og:description" content="using a TCP & UNIX sockets and SSH forwarding">
<meta property="og:type" content="article">
<meta property="og:url" content="/posts/remote-docker/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-07-11T22:46:19+02:00">
<meta property="article:modified_time" content="2021-07-11T22:46:19+02:00">
</head>
<body class=dark-theme>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>k0rventen:~</span>
<span class=logo__cursor></span>
</a>
<span class=header__right>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/manpage>manpage</a></li>
<li><a href=/>posts</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/manpage>manpage</a></li>
<li><a href=/>posts</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>Remote Docker</h1>
<div class=post-meta>
<span class=post-date>
2021-07-11
</span>
<span class=post-read-time>— 3 min read</span>
</div>
<div class=post-content>
<h2 id=what--why>what & why</h2>
<p>If you want to control a docker instance (the docker daemon) which is not your machine, you can expose it as a TCP socket (instead of a traditionnal UNIX socket) and connect to it remotely using the docker client. We&rsquo;ll also use SSH forwarding to secure the connection to the docker api if security is a concern.</p>
<h2 id=how>how</h2>
<p>Install docker</p>
<pre tabindex=0><code>curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER
</code></pre><p>then edit the systemd service unit by adding the <code>-H tcp://0.0.0.0:2375</code> to the <code>ExecStart</code> options.</p>
<pre tabindex=0><code>sudo systemctl edit docker.service

[Service]
ExecStart=
ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 --containerd=/run/containerd/containerd.sock
</code></pre><p>reload & restart</p>
<pre tabindex=0><code>sudo systemctl daemon-reload
sudo systemctl restart docker.service
</code></pre><p>FYI, the first <code>ExecStart=</code> is to <em>remove</em> the corresponding statement from the docker.service unit file. If we omit this, systemd will complain like <code>Service has more than one ExecStart= setting, which is only allowed for Type=oneshot services. Refusing.</code></p>
<p>We can check on the server that docker is indeed listening on port 2375 by running <code>sudo ss -tulnp | grep 2375</code>:</p>
<pre tabindex=0><code>tcp    LISTEN  0       4096                        *:2375               *:*      users:((&quot;dockerd&quot;,pid=11239,fd=7)) 
</code></pre><p>On our local machine we should now be able to do <code>docker -H &lt;server_ip:2375> ps</code>.</p>
<p><strong>Important note</strong>: using <code>-p</code> or <code>-v</code> will not forward ports/volumes on your local machine but on the server.</p>
<h3 id=ssh-tunnel>ssh tunnel</h3>
<p>Finally, if don&rsquo;t want to expose the bare docker API to our network, we can wrap it in a SSH tunnel !</p>
<p>(you can use <code>docker -H ssh://example.com ps</code> directly, but it&rsquo;s good to know that you can do it using ssh tunneling like a unix greybeard.)</p>
<p>I assume you have ssh enabled on the server, and copied your pubkeys to make the connection passwordless. If not, enable ssh then <code>ssh-copy-id &lt;remote_user>@&lt;server_ip></code>.</p>
<p>We can also change the override we made earlier of the docker daemon, from <code>-H tcp://0.0.0.0:2375</code> to <code>-H tcp://127.0.0.1:2375</code>, so we don&rsquo;t expose the docker API on each interface but only the loopback. (don&rsquo;t forget to reload&restart).</p>
<p>On our local machine, we&rsquo;ll do <code>ssh -L 8375:127.0.0.1:2375 -N &lt;remote_user>@&lt;server_ip></code>.</p>
<ul>
<li><code>-L</code> means to use the SSH connection to port forward to our port <code>8375</code> the port <code>127.0.0.1:2375</code> from the server point of view, which is its docker tcp socket.</li>
<li><code>-N</code> means to not launch any command</li>
</ul>
<p>You can now do <code>docker -H tcp://127.0.0.1:8375 ps</code> from our local machine, we we are now connecting through our port <code>8375</code>, which is forwarded by SSH to the port <code>2375</code> of the server.</p>
<p>But we we have a look at the ssh man page, we can read this for <code>-L</code>:</p>
<pre tabindex=0><code>     -L [bind_address:]port:host:hostport
     -L [bind_address:]port:remote_socket
     -L local_socket:host:hostport
     -L local_socket:remote_socket
</code></pre><p>I was intrigued by <code>[bind_address:]port:remote_socket</code>, specifically by <code>remote_socket</code>. That would mean we can also forward unix socket. We know that on the server, the docker API is also exposed on <code>/var/run/docker.sock</code>.</p>
<p>let&rsquo;s try <code>ssh -L 8375:/var/run/docker.sock -N &lt;remote_user>@&lt;server_ip></code>. We should redirect the docker unix socket on the server to our host&rsquo;s port <code>8375</code>.</p>
<pre tabindex=0><code>&gt; docker -H tcp://127.0.0.1:8375 ps
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
</code></pre><p>sure enough, it works !</p>
<p>As a bonus point we could disable completely the use of a TCP connection now, as we are using the unix socket on the server.</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=/posts/kube-hpa/>
<span class=button__icon>←</span>
<span class=button__text>Exploring Kube's Horizontal Pod Autoscaler</span>
</a>
</span>
<span class="button next">
<a href=/posts/kube-user/>
<span class=button__text>Add a new external user (or bot) in k8s</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>k0rventen:~</span>
<span class=logo__cursor></span>
</a>
<div class=copyright>
<span>© 2021 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span>
</div>
</div>
</footer>
<script src=/assets/main.js></script>
<script src=/assets/prism.js></script>
</div>
</body>
</html>