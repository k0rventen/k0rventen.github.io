<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Remote development in Kubernetes With Coder | k0rventen&#39;s blog</title>
<meta name="keywords" content="remote, k8s, coder">
<meta name="description" content="It&#39;s time to live in Kubernetes.">
<meta name="author" content="">
<link rel="canonical" href="/posts/remote-env-with-coder/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="/posts/remote-env-with-coder/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="/posts/remote-env-with-coder/">
  <meta property="og:site_name" content="k0rventen&#39;s blog">
  <meta property="og:title" content="Remote development in Kubernetes With Coder">
  <meta property="og:description" content="It&#39;s time to live in Kubernetes.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-06-22T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-06-22T00:00:00+00:00">
    <meta property="article:tag" content="Remote">
    <meta property="article:tag" content="K8s">
    <meta property="article:tag" content="Coder">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Remote development in Kubernetes With Coder">
<meta name="twitter:description" content="It&#39;s time to live in Kubernetes.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/posts/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Remote development in Kubernetes With Coder",
      "item": "/posts/remote-env-with-coder/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Remote development in Kubernetes With Coder",
  "name": "Remote development in Kubernetes With Coder",
  "description": "It's time to live in Kubernetes.",
  "keywords": [
    "remote", "k8s", "coder"
  ],
  "articleBody": "A fleet of remote development environments (with docker, fish shell, and even minikube) running in your kubernetes cluster, accessible through VS Code in the browser !\nThere should have been a video here but your browser does not seem to support it. What \u0026 why This setup is the v2 of a previous post on remote dev env using jupyterlab I made a year and a half ago. Thee OG setup was functionnal, but it had some issues, mainly around user management, container lifecycle and persistent data handling. As $dayjob has grown, so has the infrastructure, and so has the development needs. So a new solution was required.\nA lot of them exists right now for remote environments, from providers like Github Codespaces, Gitpod, or even DevPod. But the folks at Coder released coder v2 a while back, and that’s what I’ve used for managing our team’s environments since late 2022.\nThe devs needs haven’t changed a lot since the first post. Our workflow is cluster-centric, based on skaffold to redeploy our built-on-the-fly-containers as pods directly onto the cluster.\nHow The stack consists of these parts:\na docker image that will be used as the base for our remote envs a kubernetes cluster, which will host everything, the coder platform deployed on said cluster, a custom kubernetes provider for running our docker image inside coder, handling some specific needs we have with our dev envs The Base Image The idea of the base image is to bake everything needed directly into it: vscode, git, fish shell, docker (running in a Docker-in-Docker fashion). I’ve already built this image, available at k0rventen/code, but if you want to tweak it, you’ll find the necessary files below:\nWe’re using an Ubuntu base, plus:\nwe install basic dev utils and requirements for running dockerd we copy the dockerd stuff from their own image we install code-server we change the default shell to fish and copy over our base config files we start a bootstrap.fish script # base image using ubuntu FROM ubuntu:23.04 # install utils (fish shell, ssh) RUN apt update \u0026\u0026 apt install -y --no-install-recommends curl ca-certificates git iptables fuse-overlayfs dnsutils less fish openssh-client \u0026\u0026 apt clean #install code-server RUN curl -fsSL https://code-server.dev/install.sh | sh -s -- --version 4.14.0 \u0026\u0026 rm -rvf /root/.cache # copy dockerd binaries from the docker image COPY --from=docker:20-dind /usr/local/bin/ /usr/local/bin/ # shell config RUN chsh -s /usr/bin/fish COPY config/ /tmp/code # run our launch script ENTRYPOINT [\"fish\", \"/tmp/code/bootstrap.fish\"] The bootstrap.fish has the following duties:\nmake sure mandatory directories are here install Linuxbrew if not present (which will run only once, during the first startup of the env) start the dockerd daemon in the background then start code-server Here is its content: bootstrap.fish\ncd $home mkdir -p projects .config/fish if test ! -e .config/fish/config.fish echo \"copying fish config\" cp -v /tmp/code/config.fish .config/fish/config.fish end if test ! -e /home/linuxbrew/.linuxbrew/bin echo \"installing linuxbrew\" bash -c 'NONINTERACTIVE=1 /bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"' \u0026 end echo \"starting dockerd..\" sh /usr/local/bin/dockerd-entrypoint.sh \u0026 echo \"starting code server\" exec code-server --bind-addr 0.0.0.0:9069 --auth none --disable-telemetry --disable-update-check projects The config.fish is a very minimal config to get us started:\nconfig.fish\n# quiet fish set fish_greeting set -gx HOMEBREW_NO_ENV_HINTS 1 set -gx HOMEBREW_NO_INSTALL_CLEANUP 1 # brew fish fish_add_path /home/linuxbrew/.linuxbrew/bin # simple fish function fish_prompt printf '\\n%s[%s]%s \u003e ' (set_color cyan) (prompt_pwd) (set_color normal) end The Coder platform Coder can be installed on a lot of platform, including docker, k8s and friends. Here we’ll concentrate on Kube. Requirements are a cluster with a storage class and an Ingress controller. You’ll need helm as well.\nFrom this point forward, I’ll assume that you have a cluster which can be accessed using the domain names coder.org and *.coder.org (You can add them in your local DNS server, or as entries in your /etc/hosts file wildcards aren’t supported, but for testing purposes you could write the required subdomains as needed).\nDepending on the setup you’ll need to adjust some variables in the files below.\nThe configuration of the platform is done through the values.yaml passed to helm. The important bit is the CODER_ACCESS_URL and CODER_WILDCARD_ACCESS_URL env vars and ingress config. They will define how clients can access the platform and their envs.\nvalues.yaml\ncoder: env: - name: CODER_PG_CONNECTION_URL valueFrom: secretKeyRef: name: coder-db-url key: url - name: CODER_ACCESS_URL value: \"https://coder.org\" - name: CODER_TELEMETRY value: \"false\" - name: CODER_WILDCARD_ACCESS_URL value: \"*.coder.org\" - name: CODER_AGENT_URL value: \"http://coder\" service: type: ClusterIP ingress: enable: true host: \"coder.org\" wildcardHost: \"*.coder.org\" annotations: nginx.ingress.kubernetes.io/enable-cors: \"true\" tls: enable: true Now we can deploy everything:\n# create a namespace for our platform kubectl create ns coder kubectl config set-context --current --namespace coder # postgres will be used by coder helm repo add bitnami https://charts.bitnami.com/bitnami helm install coder-db bitnami/postgresql --namespace coder --set auth.username=coder --set auth.password=coder --set auth.database=coder --set persistence.size=10Gi # create a secret for coder holding the db creds kubectl create secret generic coder-db-url --from-literal=url=\"postgres://coder:coder@coder-db-postgresql.coder.svc.cluster.local:5432/coder?sslmode=disable\" # deploy coder helm repo add coder-v2 https://helm.coder.com/v2 helm upgrade --install coder coder-v2/coder --namespace coder --values values.yaml You should be able to access the management interface at https://coder.org. Create your admin user there and come back.\nThe custom Kubernetes provider We now need to register a provider for our environments. The default Kubernetes provider available is a good start, but we’ll tweak it a bit to our needs. It’s a single Terraform file defining the ressources to be created. It’s quite long but the gist is that each environment will be composed of:\n1 Pod that will execute our dev env, with configurable ressources allocations (CPU \u0026 RAM) 3 PersistantVolumeClaims one for our home folder, mounted on /root one for the dockerd daemon files, on /var/lib/docker one for linuxbrew at /home/linuxbrew The file is quite long: main.tf terraform { required_providers { coder = { source = \"coder/coder\" version = \"~\u003e 0.7.0\" } kubernetes = { source = \"hashicorp/kubernetes\" version = \"~\u003e 2.18\" } } } provider \"coder\" { feature_use_managed_variables = true } variable \"namespace\" { type = string description = \"The Kubernetes namespace to create workspaces in (must exist prior to creating workspaces)\" default = \"coder\" } data \"coder_parameter\" \"cpu\" { name = \"cpu\" display_name = \"CPU\" description = \"The number of CPU cores\" default = \"2\" icon = \"/icon/memory.svg\" mutable = true option { name = \"Light machine (2 Cores)\" value = \"2\" } option { name = \"Heavy Machine (8 Cores)\" value = \"8\" } } data \"coder_parameter\" \"memory\" { name = \"memory\" display_name = \"Memory\" description = \"The amount of memory in GB\" default = \"2\" icon = \"/icon/memory.svg\" mutable = true option { name = \"2 GB\" value = \"2\" } option { name = \"8 GB\" value = \"8\" } } data \"coder_parameter\" \"image\" { name = \"Image\" display_name = \"Container Image\" description = \"The base container image to use\" default = \"k0rventen/code:0.1\" icon = \"/icon/memory.svg\" mutable = true type = \"string\" } provider \"kubernetes\" { # Authenticate via ~/.kube/config or a Coder-specific ServiceAccount, depending on admin preferences config_path = null } data \"coder_workspace\" \"me\" {} resource \"coder_agent\" \"main\" { os = \"linux\" arch = \"amd64\" startup_script_timeout = 180 startup_script = \u003c\u003c-EOT set -e fish /tmp/code/bootstrap.fish EOT } # code-server resource \"coder_app\" \"code-server\" { agent_id = coder_agent.main.id slug = \"code-server\" display_name = \"code-server\" icon = \"/icon/code.svg\" url = \"http://localhost:9069?folder=/root/projects\" subdomain = false share = \"owner\" healthcheck { url = \"http://localhost:9069/healthz\" interval = 3 threshold = 10 } } resource \"kubernetes_persistent_volume_claim\" \"home\" { metadata { name = \"coder-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}-home\" namespace = var.namespace labels = { \"app.kubernetes.io/name\" = \"coder-pvc\" \"app.kubernetes.io/instance\" = \"coder-pvc-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}\" \"app.kubernetes.io/part-of\" = \"coder\" // Coder specific labels. \"com.coder.resource\" = \"true\" \"com.coder.workspace.id\" = data.coder_workspace.me.id \"com.coder.workspace.name\" = data.coder_workspace.me.name \"com.coder.user.id\" = data.coder_workspace.me.owner_id \"com.coder.user.username\" = data.coder_workspace.me.owner } annotations = { \"com.coder.user.email\" = data.coder_workspace.me.owner_email } } wait_until_bound = false spec { access_modes = [\"ReadWriteOnce\"] resources { requests = { storage = \"4Gi\" } } } } resource \"kubernetes_persistent_volume_claim\" \"docker\" { metadata { name = \"coder-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}-docker\" namespace = var.namespace labels = { \"app.kubernetes.io/name\" = \"coder-pvc\" \"app.kubernetes.io/instance\" = \"coder-pvc-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}\" \"app.kubernetes.io/part-of\" = \"coder\" // Coder specific labels. \"com.coder.resource\" = \"true\" \"com.coder.workspace.id\" = data.coder_workspace.me.id \"com.coder.workspace.name\" = data.coder_workspace.me.name \"com.coder.user.id\" = data.coder_workspace.me.owner_id \"com.coder.user.username\" = data.coder_workspace.me.owner } annotations = { \"com.coder.user.email\" = data.coder_workspace.me.owner_email } } wait_until_bound = false spec { access_modes = [\"ReadWriteOnce\"] resources { requests = { storage = \"10Gi\" } } } } resource \"kubernetes_persistent_volume_claim\" \"linuxbrew\" { metadata { name = \"coder-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}-linuxbrew\" namespace = var.namespace labels = { \"app.kubernetes.io/name\" = \"coder-pvc\" \"app.kubernetes.io/instance\" = \"coder-pvc-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}\" \"app.kubernetes.io/part-of\" = \"coder\" // Coder specific labels. \"com.coder.resource\" = \"true\" \"com.coder.workspace.id\" = data.coder_workspace.me.id \"com.coder.workspace.name\" = data.coder_workspace.me.name \"com.coder.user.id\" = data.coder_workspace.me.owner_id \"com.coder.user.username\" = data.coder_workspace.me.owner } annotations = { \"com.coder.user.email\" = data.coder_workspace.me.owner_email } } wait_until_bound = false spec { access_modes = [\"ReadWriteOnce\"] resources { requests = { storage = \"10Gi\" } } } } resource \"kubernetes_pod\" \"main\" { count = data.coder_workspace.me.start_count metadata { name = \"coder-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}\" namespace = var.namespace labels = { \"app.kubernetes.io/name\" = \"coder-workspace\" \"app.kubernetes.io/instance\" = \"coder-workspace-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}\" \"app.kubernetes.io/part-of\" = \"coder\" // Coder specific labels. \"com.coder.resource\" = \"true\" \"com.coder.workspace.id\" = data.coder_workspace.me.id \"com.coder.workspace.name\" = data.coder_workspace.me.name \"com.coder.user.id\" = data.coder_workspace.me.owner_id \"com.coder.user.username\" = data.coder_workspace.me.owner } annotations = { \"com.coder.user.email\" = data.coder_workspace.me.owner_email } } spec { container { name = \"code-container\" image = \"${data.coder_parameter.image.value}\" image_pull_policy = \"Always\" command = [\"sh\", \"-c\", replace(coder_agent.main.init_script,\"https://coder.org\",\"http://coder\")] env { name = \"CODER_AGENT_TOKEN\" value = coder_agent.main.token } security_context { privileged = \"true\" } resources { requests = { \"cpu\" = \"250m\" \"memory\" = \"512Mi\" } limits = { \"cpu\" = \"${data.coder_parameter.cpu.value}\" \"memory\" = \"${data.coder_parameter.memory.value}Gi\" } } volume_mount { mount_path = \"/root\" name = \"home\" read_only = false } volume_mount { mount_path = \"/var/lib/docker\" name = \"docker\" read_only = false } volume_mount { mount_path = \"/home/linuxbrew\" name = \"linuxbrew\" read_only = false } } volume { name = \"home\" persistent_volume_claim { claim_name = kubernetes_persistent_volume_claim.home.metadata.0.name read_only = false } } volume { name = \"docker\" persistent_volume_claim { claim_name = kubernetes_persistent_volume_claim.docker.metadata.0.name read_only = false } } volume { name = \"linuxbrew\" persistent_volume_claim { claim_name = kubernetes_persistent_volume_claim.linuxbrew.metadata.0.name read_only = false } } } } Note: One quirk of this setup is that due to our environment using self signed certificate, we have to replace the external URL (the one used to access the envs) by the internal one (the coder service inside the ns) for our envs to start properly. In a more realistic scenario, trusted CA certs would be used instead.\nTo deploy this provider to our Coder instance, we’ll need the coder cli, available here. Depending on the exact setup (mainly due to self signed certificates), the login endpoint will vary, but the easiest is to port-forward the internal coder service and login through this:\n# in a tab kubectl port-forward svc/coder 8080:80 # in another tab, then follow the login procedure coder login http://127.0.0.1:8080 # once logged in, in the same dir as `main.tf`, reply yes to questions coder template create kube # You should preview the resources that will be created for each env: ┌──────────────────────────────────────────────────┐ │ Template Preview │ ├──────────────────────────────────────────────────┤ │ RESOURCE │ ├──────────────────────────────────────────────────┤ │ kubernetes_persistent_volume_claim.docker │ ├──────────────────────────────────────────────────┤ │ kubernetes_persistent_volume_claim.home │ ├──────────────────────────────────────────────────┤ │ kubernetes_persistent_volume_claim.linuxbrew │ ├──────────────────────────────────────────────────┤ │ kubernetes_pod.main │ │ └─ main (linux, amd64) │ └──────────────────────────────────────────────────┘ Accessing our environment Now everything required to work directly into our cluster is deployed. We can now create a Workspace based on the provider we defined earlier: Wait for the pod to be created and the code-server button to become available. Now we can work using a web browser from our thin \u0026 light laptop (or even a Raspberry Pi) with the power of a cluster:\nThere should have been a video here but your browser does not seem to support it. Disclaimer This setup is loosely based on what is deployed and used daily at $job. The main upsides are that :\nonboarding/updating/offboarding the environments are dead-easy, laptops are running way cooler, batteries last longer and builds are way faster, and testing has very little friction due to the fact that we are right inside the cluster. But there is some downsides:\nnotably around security, our envs are running as privileged in the cluster (for dockerd), which might not be fine depending on the level of trust you want. One possible fix would be to switch to a rootless docker/podman, but as of time of writing, there are too many quirks when deploying such solutions. having the dev envs centralised means possibly a SPOF that could ruin everyone’s day if something goes wrong with the platform or the cluster. it might require a certain level of maturity around containers, mainly around how networking is affected by a remote setup. ",
  "wordCount" : "2061",
  "inLanguage": "en",
  "datePublished": "2023-06-22T00:00:00Z",
  "dateModified": "2023-06-22T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/posts/remote-env-with-coder/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "k0rventen's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="&gt; k0rventen: ~ (Alt + H)">&gt; k0rventen: ~</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="/links" title="links">
                    <span>links</span>
                </a>
            </li>
            <li>
                <a href="/posts" title="posts">
                    <span>posts</span>
                </a>
            </li>
            <li>
                <a href="/search" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Remote development in Kubernetes With Coder
    </h1>
    <div class="post-description">
      It&#39;s time to live in Kubernetes.
    </div>
    <div class="post-meta"><span title='2023-06-22 00:00:00 +0000 UTC'>June 22, 2023</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;2061 words

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#the-base-image">The Base Image</a></li>
    <li><a href="#the-coder-platform">The Coder platform</a></li>
    <li><a href="#the-custom-kubernetes-provider">The custom Kubernetes provider</a></li>
    <li><a href="#accessing-our-environment">Accessing our environment</a></li>
    <li><a href="#disclaimer">Disclaimer</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p><em>A fleet of remote development environments (with docker, fish shell, and even minikube) running in your kubernetes cluster, accessible through VS Code in the browser !</em></p>
<video class="video-shortcode" preload="auto" controls autoplay width="100%">
  <source src="/coder-remote-env/demo.mp4" type="video/mp4">
  There should have been a video here but your browser does not seem to support it.
</video>
<h1 id="what--why">What &amp; why<a hidden class="anchor" aria-hidden="true" href="#what--why">#</a></h1>
<p>This setup is the v2 of a previous post on remote dev env <a href="/posts/remote-mulituser-vscode-kubernetes/">using jupyterlab</a> I made a year and a half ago. Thee OG setup was functionnal, but it had some issues, mainly around user management, container lifecycle and persistent data handling. As $dayjob has grown, so has the infrastructure, and so has the development needs. So a new solution was required.</p>
<p>A lot of them exists right now for remote environments, from providers like <a href="https://github.com/features/codespaces">Github Codespaces</a>, <a href="https://www.gitpod.io/">Gitpod</a>, or even <a href="https://devpod.sh/">DevPod</a>. But the folks at Coder released <a href="https://github.com/coder/coder">coder v2</a> a while back, and that&rsquo;s what I&rsquo;ve used for managing our team&rsquo;s environments since late 2022.</p>
<p>The devs needs haven&rsquo;t changed a lot since the first post. Our workflow is cluster-centric, based on skaffold to redeploy our built-on-the-fly-containers as pods directly onto the cluster.</p>
<h1 id="how">How<a hidden class="anchor" aria-hidden="true" href="#how">#</a></h1>
<p>The stack consists of these parts:</p>
<ul>
<li>a docker image that will be used as the base for our remote envs</li>
<li>a kubernetes cluster, which will host everything,</li>
<li>the coder platform deployed on said cluster,</li>
<li>a custom kubernetes provider for running our docker image inside coder, handling some specific needs we have with our dev envs</li>
</ul>
<h2 id="the-base-image">The Base Image<a hidden class="anchor" aria-hidden="true" href="#the-base-image">#</a></h2>
<p>The idea of the base image is to bake everything needed directly into it: vscode, git, fish shell, docker (running in a Docker-in-Docker fashion). I&rsquo;ve already built this image, available at <a href="https://hub.docker.com/r/k0rventen/code/tags"><em>k0rventen/code</em></a>, but if you want to tweak it, you&rsquo;ll find the necessary files below:</p>
<p>We&rsquo;re using an Ubuntu base, plus:</p>
<ul>
<li>we install basic dev utils and requirements for running dockerd</li>
<li>we copy the dockerd stuff from their own image</li>
<li>we install code-server</li>
<li>we change the default shell to fish and copy over our base config files</li>
<li>we start a <em>bootstrap.fish</em> script</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="line"><span class="cl"><span class="c"># base image using ubuntu</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> ubuntu:23.04</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># install utils (fish shell, ssh)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt update <span class="o">&amp;&amp;</span> apt install -y --no-install-recommends curl ca-certificates git iptables fuse-overlayfs dnsutils less fish openssh-client <span class="o">&amp;&amp;</span> apt clean<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c">#install code-server</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> curl -fsSL https://code-server.dev/install.sh <span class="p">|</span> sh -s -- --version 4.14.0 <span class="o">&amp;&amp;</span> rm -rvf /root/.cache<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># copy dockerd binaries from the docker image</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>docker:20-dind /usr/local/bin/ /usr/local/bin/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># shell config</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> chsh -s /usr/bin/fish<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> config/ /tmp/code<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># run our launch script</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&#34;fish&#34;</span><span class="p">,</span> <span class="s2">&#34;/tmp/code/bootstrap.fish&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></div><p>The <code>bootstrap.fish</code> has the following duties:</p>
<ul>
<li>make sure mandatory directories are here</li>
<li>install Linuxbrew if not present (which will run only once, during the first startup of the env)</li>
<li>start the dockerd daemon in the background</li>
<li>then start code-server</li>
</ul>
<p>Here is its content:
<em>bootstrap.fish</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">cd</span> <span class="nv">$home</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mkdir -p projects .config/fish
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> ! -e .config/fish/config.fish
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;copying fish config&#34;</span>
</span></span><span class="line"><span class="cl">  cp -v /tmp/code/config.fish  .config/fish/config.fish
</span></span><span class="line"><span class="cl">end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">test</span> ! -e /home/linuxbrew/.linuxbrew/bin
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;installing linuxbrew&#34;</span>
</span></span><span class="line"><span class="cl">  bash -c <span class="s1">&#39;NONINTERACTIVE=1 /bin/bash -c &#34;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)&#34;&#39;</span> <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl">end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;starting dockerd..&#34;</span>
</span></span><span class="line"><span class="cl">sh /usr/local/bin/dockerd-entrypoint.sh <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;starting code server&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> code-server --bind-addr 0.0.0.0:9069 --auth none --disable-telemetry --disable-update-check projects
</span></span></code></pre></div><p>The <em>config.fish</em> is a very minimal config to get us started:</p>
<p><em>config.fish</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># quiet fish</span>
</span></span><span class="line"><span class="cl"><span class="nb">set</span> fish_greeting
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -gx HOMEBREW_NO_ENV_HINTS <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -gx HOMEBREW_NO_INSTALL_CLEANUP <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># brew fish</span>
</span></span><span class="line"><span class="cl">fish_add_path /home/linuxbrew/.linuxbrew/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># simple fish </span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> fish_prompt
</span></span><span class="line"><span class="cl">  <span class="nb">printf</span> <span class="s1">&#39;\n%s[%s]%s &gt; &#39;</span> <span class="o">(</span>set_color cyan<span class="o">)</span> <span class="o">(</span>prompt_pwd<span class="o">)</span> <span class="o">(</span>set_color normal<span class="o">)</span>
</span></span><span class="line"><span class="cl">end
</span></span></code></pre></div><h2 id="the-coder-platform">The Coder platform<a hidden class="anchor" aria-hidden="true" href="#the-coder-platform">#</a></h2>
<p>Coder can be installed on a lot of platform, including docker, k8s and friends. Here we&rsquo;ll concentrate on Kube. Requirements are a cluster with a storage class and an Ingress controller. You&rsquo;ll need <code>helm</code> as well.</p>
<p>From this point forward, I&rsquo;ll assume that you have a cluster which can be accessed using the domain names <code>coder.org</code> and <code>*.coder.org</code> (You can add them in your local DNS server, or as entries in your /etc/hosts file <em>wildcards aren&rsquo;t supported, but for testing purposes you could write the required subdomains as needed</em>).</p>
<p>Depending on the setup you&rsquo;ll need to adjust some variables in the files below.</p>
<p>The configuration of the platform is done through the <code>values.yaml</code> passed to helm. The important bit is the <code>CODER_ACCESS_URL</code> and <code>CODER_WILDCARD_ACCESS_URL</code> env vars and ingress config. They will define how clients can access the platform and their envs.</p>
<p><em>values.yaml</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">coder</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">CODER_PG_CONNECTION_URL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">coder-db-url</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">url</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">CODER_ACCESS_URL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://coder.org&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">CODER_TELEMETRY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">CODER_WILDCARD_ACCESS_URL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*.coder.org&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">CODER_AGENT_URL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">  </span><span class="s2">&#34;http://coder&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;coder.org&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">wildcardHost</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*.coder.org&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/enable-cors</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>Now we can deploy everything:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># create a namespace for our platform</span>
</span></span><span class="line"><span class="cl">kubectl create ns coder
</span></span><span class="line"><span class="cl">kubectl config set-context --current --namespace coder
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># postgres will be used by coder</span>
</span></span><span class="line"><span class="cl">helm repo add bitnami https://charts.bitnami.com/bitnami
</span></span><span class="line"><span class="cl">helm install coder-db bitnami/postgresql --namespace coder --set auth.username<span class="o">=</span>coder --set auth.password<span class="o">=</span>coder --set auth.database<span class="o">=</span>coder --set persistence.size<span class="o">=</span>10Gi
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># create a secret for coder holding the db creds</span>
</span></span><span class="line"><span class="cl">kubectl create secret generic coder-db-url --from-literal<span class="o">=</span><span class="nv">url</span><span class="o">=</span><span class="s2">&#34;postgres://coder:coder@coder-db-postgresql.coder.svc.cluster.local:5432/coder?sslmode=disable&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># deploy coder</span>
</span></span><span class="line"><span class="cl">helm repo add coder-v2 https://helm.coder.com/v2
</span></span><span class="line"><span class="cl">helm upgrade --install coder coder-v2/coder --namespace coder --values values.yaml
</span></span></code></pre></div><p>You should be able to access the management interface at <code>https://coder.org</code>. Create your admin user there and come back.</p>
<h2 id="the-custom-kubernetes-provider">The custom Kubernetes provider<a hidden class="anchor" aria-hidden="true" href="#the-custom-kubernetes-provider">#</a></h2>
<p>We now need to register a provider for our environments. The default <code>Kubernetes</code> provider available is a good start, but we&rsquo;ll tweak it a bit to our needs. It&rsquo;s a single Terraform file defining the ressources to be created. It&rsquo;s quite long but the gist is that each environment will be composed of:</p>
<ul>
<li>1 Pod that will execute our dev env, with configurable ressources allocations (CPU &amp; RAM)</li>
<li>3 PersistantVolumeClaims
<ul>
<li>one for our home folder, mounted on <code>/root</code></li>
<li>one for the dockerd daemon files, on <code>/var/lib/docker</code></li>
<li>one for linuxbrew at <code>/home/linuxbrew</code></li>
</ul>
</li>
</ul>
<p>The file is quite long:
<details >
    <summary><strong>main.tf</strong></summary>
        <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-h" data-lang="h"><span class="line"><span class="cl"><span class="n">terraform</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">required_providers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">coder</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">source</span>  <span class="o">=</span> <span class="s">&#34;coder/coder&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="n">version</span> <span class="o">=</span> <span class="s">&#34;~&gt; 0.7.0&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">kubernetes</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">source</span>  <span class="o">=</span> <span class="s">&#34;hashicorp/kubernetes&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="n">version</span> <span class="o">=</span> <span class="s">&#34;~&gt; 2.18&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">provider</span> <span class="s">&#34;coder&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">feature_use_managed_variables</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">variable</span> <span class="s">&#34;namespace&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">type</span>        <span class="o">=</span> <span class="n">string</span>
</span></span><span class="line"><span class="cl">  <span class="n">description</span> <span class="o">=</span> <span class="s">&#34;The Kubernetes namespace to create workspaces in (must exist prior to creating workspaces)&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">default</span>      <span class="o">=</span> <span class="s">&#34;coder&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="s">&#34;coder_parameter&#34;</span> <span class="s">&#34;cpu&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">name</span>         <span class="o">=</span> <span class="s">&#34;cpu&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">display_name</span> <span class="o">=</span> <span class="s">&#34;CPU&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">description</span>  <span class="o">=</span> <span class="s">&#34;The number of CPU cores&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">default</span>      <span class="o">=</span> <span class="s">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">icon</span>         <span class="o">=</span> <span class="s">&#34;/icon/memory.svg&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mutable</span>      <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  <span class="n">option</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span>  <span class="o">=</span> <span class="s">&#34;Light machine (2 Cores)&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="s">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">option</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span>  <span class="o">=</span> <span class="s">&#34;Heavy Machine (8 Cores)&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="s">&#34;8&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="s">&#34;coder_parameter&#34;</span> <span class="s">&#34;memory&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">name</span>         <span class="o">=</span> <span class="s">&#34;memory&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">display_name</span> <span class="o">=</span> <span class="s">&#34;Memory&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">description</span>  <span class="o">=</span> <span class="s">&#34;The amount of memory in GB&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">default</span>      <span class="o">=</span> <span class="s">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">icon</span>         <span class="o">=</span> <span class="s">&#34;/icon/memory.svg&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mutable</span>      <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  <span class="n">option</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span>  <span class="o">=</span> <span class="s">&#34;2 GB&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="s">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">option</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span>  <span class="o">=</span> <span class="s">&#34;8 GB&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="s">&#34;8&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="s">&#34;coder_parameter&#34;</span> <span class="s">&#34;image&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">name</span>         <span class="o">=</span> <span class="s">&#34;Image&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">display_name</span> <span class="o">=</span> <span class="s">&#34;Container Image&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">description</span>  <span class="o">=</span> <span class="s">&#34;The base container image to use&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">default</span>      <span class="o">=</span> <span class="s">&#34;k0rventen/code:0.1&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">icon</span>         <span class="o">=</span> <span class="s">&#34;/icon/memory.svg&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mutable</span>      <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  <span class="n">type</span>         <span class="o">=</span> <span class="s">&#34;string&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">provider</span> <span class="s">&#34;kubernetes&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cp"># Authenticate via ~/.kube/config or a Coder-specific ServiceAccount, depending on admin preferences
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">config_path</span> <span class="o">=</span> <span class="n">null</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="s">&#34;coder_workspace&#34;</span> <span class="s">&#34;me&#34;</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">resource</span> <span class="s">&#34;coder_agent&#34;</span> <span class="s">&#34;main&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">os</span>                     <span class="o">=</span> <span class="s">&#34;linux&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">arch</span>                   <span class="o">=</span> <span class="s">&#34;amd64&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">startup_script_timeout</span> <span class="o">=</span> <span class="mi">180</span>
</span></span><span class="line"><span class="cl">  <span class="n">startup_script</span>         <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="n">EOT</span>
</span></span><span class="line"><span class="cl">    <span class="n">set</span> <span class="o">-</span><span class="n">e</span>
</span></span><span class="line"><span class="cl">    <span class="n">fish</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">bootstrap</span><span class="p">.</span><span class="n">fish</span>
</span></span><span class="line"><span class="cl">  <span class="n">EOT</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp"># code-server
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">resource</span> <span class="s">&#34;coder_app&#34;</span> <span class="s">&#34;code-server&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">agent_id</span>     <span class="o">=</span> <span class="n">coder_agent</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">id</span>
</span></span><span class="line"><span class="cl">  <span class="n">slug</span>         <span class="o">=</span> <span class="s">&#34;code-server&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">display_name</span> <span class="o">=</span> <span class="s">&#34;code-server&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">icon</span>         <span class="o">=</span> <span class="s">&#34;/icon/code.svg&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">url</span>          <span class="o">=</span> <span class="s">&#34;http://localhost:9069?folder=/root/projects&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">subdomain</span>    <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">  <span class="n">share</span>        <span class="o">=</span> <span class="s">&#34;owner&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">healthcheck</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">url</span>       <span class="o">=</span> <span class="s">&#34;http://localhost:9069/healthz&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">interval</span>  <span class="o">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="n">threshold</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">resource</span> <span class="s">&#34;kubernetes_persistent_volume_claim&#34;</span> <span class="s">&#34;home&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">metadata</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span>      <span class="o">=</span> <span class="s">&#34;coder-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}-home&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">namespace</span> <span class="o">=</span> <span class="n">var</span><span class="p">.</span><span class="n">namespace</span>
</span></span><span class="line"><span class="cl">    <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;app.kubernetes.io/name&#34;</span>     <span class="o">=</span> <span class="s">&#34;coder-pvc&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;app.kubernetes.io/instance&#34;</span> <span class="o">=</span> <span class="s">&#34;coder-pvc-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;app.kubernetes.io/part-of&#34;</span>  <span class="o">=</span> <span class="s">&#34;coder&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Coder specific labels.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="s">&#34;com.coder.resource&#34;</span>       <span class="o">=</span> <span class="s">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.workspace.id&#34;</span>   <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">id</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.workspace.name&#34;</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.user.id&#34;</span>        <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">owner_id</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.user.username&#34;</span>  <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">owner</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">annotations</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.user.email&#34;</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">owner_email</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">wait_until_bound</span> <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">  <span class="n">spec</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">access_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#34;ReadWriteOnce&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">resources</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">requests</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">storage</span> <span class="o">=</span> <span class="s">&#34;4Gi&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">resource</span> <span class="s">&#34;kubernetes_persistent_volume_claim&#34;</span> <span class="s">&#34;docker&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">metadata</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span>      <span class="o">=</span> <span class="s">&#34;coder-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}-docker&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">namespace</span> <span class="o">=</span> <span class="n">var</span><span class="p">.</span><span class="n">namespace</span>
</span></span><span class="line"><span class="cl">    <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;app.kubernetes.io/name&#34;</span>     <span class="o">=</span> <span class="s">&#34;coder-pvc&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;app.kubernetes.io/instance&#34;</span> <span class="o">=</span> <span class="s">&#34;coder-pvc-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;app.kubernetes.io/part-of&#34;</span>  <span class="o">=</span> <span class="s">&#34;coder&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Coder specific labels.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="s">&#34;com.coder.resource&#34;</span>       <span class="o">=</span> <span class="s">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.workspace.id&#34;</span>   <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">id</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.workspace.name&#34;</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.user.id&#34;</span>        <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">owner_id</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.user.username&#34;</span>  <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">owner</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">annotations</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.user.email&#34;</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">owner_email</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">wait_until_bound</span> <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">  <span class="n">spec</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">access_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#34;ReadWriteOnce&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">resources</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">requests</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">storage</span> <span class="o">=</span> <span class="s">&#34;10Gi&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">resource</span> <span class="s">&#34;kubernetes_persistent_volume_claim&#34;</span> <span class="s">&#34;linuxbrew&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">metadata</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span>      <span class="o">=</span> <span class="s">&#34;coder-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}-linuxbrew&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">namespace</span> <span class="o">=</span> <span class="n">var</span><span class="p">.</span><span class="n">namespace</span>
</span></span><span class="line"><span class="cl">    <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;app.kubernetes.io/name&#34;</span>     <span class="o">=</span> <span class="s">&#34;coder-pvc&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;app.kubernetes.io/instance&#34;</span> <span class="o">=</span> <span class="s">&#34;coder-pvc-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;app.kubernetes.io/part-of&#34;</span>  <span class="o">=</span> <span class="s">&#34;coder&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Coder specific labels.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="s">&#34;com.coder.resource&#34;</span>       <span class="o">=</span> <span class="s">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.workspace.id&#34;</span>   <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">id</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.workspace.name&#34;</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.user.id&#34;</span>        <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">owner_id</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.user.username&#34;</span>  <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">owner</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">annotations</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.user.email&#34;</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">owner_email</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">wait_until_bound</span> <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">  <span class="n">spec</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">access_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#34;ReadWriteOnce&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">resources</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">requests</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">storage</span> <span class="o">=</span> <span class="s">&#34;10Gi&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">resource</span> <span class="s">&#34;kubernetes_pod&#34;</span> <span class="s">&#34;main&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">count</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">start_count</span>
</span></span><span class="line"><span class="cl">  <span class="n">metadata</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span>      <span class="o">=</span> <span class="s">&#34;coder-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">namespace</span> <span class="o">=</span> <span class="n">var</span><span class="p">.</span><span class="n">namespace</span>
</span></span><span class="line"><span class="cl">    <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;app.kubernetes.io/name&#34;</span>     <span class="o">=</span> <span class="s">&#34;coder-workspace&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;app.kubernetes.io/instance&#34;</span> <span class="o">=</span> <span class="s">&#34;coder-workspace-${lower(data.coder_workspace.me.owner)}-${lower(data.coder_workspace.me.name)}&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;app.kubernetes.io/part-of&#34;</span>  <span class="o">=</span> <span class="s">&#34;coder&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Coder specific labels.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="s">&#34;com.coder.resource&#34;</span>       <span class="o">=</span> <span class="s">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.workspace.id&#34;</span>   <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">id</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.workspace.name&#34;</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.user.id&#34;</span>        <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">owner_id</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.user.username&#34;</span>  <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">owner</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">annotations</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;com.coder.user.email&#34;</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">coder_workspace</span><span class="p">.</span><span class="n">me</span><span class="p">.</span><span class="n">owner_email</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">spec</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">container</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">name</span>              <span class="o">=</span> <span class="s">&#34;code-container&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="n">image</span>             <span class="o">=</span> <span class="s">&#34;${data.coder_parameter.image.value}&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="n">image_pull_policy</span> <span class="o">=</span> <span class="s">&#34;Always&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="n">command</span>           <span class="o">=</span> <span class="p">[</span><span class="s">&#34;sh&#34;</span><span class="p">,</span> <span class="s">&#34;-c&#34;</span><span class="p">,</span> <span class="nf">replace</span><span class="p">(</span><span class="n">coder_agent</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">init_script</span><span class="p">,</span><span class="s">&#34;https://coder.org&#34;</span><span class="p">,</span><span class="s">&#34;http://coder&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">      <span class="n">env</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span>  <span class="o">=</span> <span class="s">&#34;CODER_AGENT_TOKEN&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span> <span class="o">=</span> <span class="n">coder_agent</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">token</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">security_context</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">privileged</span> <span class="o">=</span> <span class="s">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">resources</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">requests</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;cpu&#34;</span>    <span class="o">=</span> <span class="s">&#34;250m&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;memory&#34;</span> <span class="o">=</span> <span class="s">&#34;512Mi&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">limits</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;cpu&#34;</span>    <span class="o">=</span> <span class="s">&#34;${data.coder_parameter.cpu.value}&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="s">&#34;memory&#34;</span> <span class="o">=</span> <span class="s">&#34;${data.coder_parameter.memory.value}Gi&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">volume_mount</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mount_path</span> <span class="o">=</span> <span class="s">&#34;/root&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span>       <span class="o">=</span> <span class="s">&#34;home&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">read_only</span>  <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">volume_mount</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mount_path</span> <span class="o">=</span> <span class="s">&#34;/var/lib/docker&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span>       <span class="o">=</span> <span class="s">&#34;docker&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">read_only</span>  <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">volume_mount</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mount_path</span> <span class="o">=</span> <span class="s">&#34;/home/linuxbrew&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span>       <span class="o">=</span> <span class="s">&#34;linuxbrew&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">read_only</span>  <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">volume</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">name</span> <span class="o">=</span> <span class="s">&#34;home&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="n">persistent_volume_claim</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">claim_name</span> <span class="o">=</span> <span class="n">kubernetes_persistent_volume_claim</span><span class="p">.</span><span class="n">home</span><span class="p">.</span><span class="n">metadata</span><span class="mf">.0</span><span class="p">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">        <span class="n">read_only</span>  <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">volume</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">name</span> <span class="o">=</span> <span class="s">&#34;docker&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="n">persistent_volume_claim</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">claim_name</span> <span class="o">=</span> <span class="n">kubernetes_persistent_volume_claim</span><span class="p">.</span><span class="n">docker</span><span class="p">.</span><span class="n">metadata</span><span class="mf">.0</span><span class="p">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">        <span class="n">read_only</span>  <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">volume</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">name</span> <span class="o">=</span> <span class="s">&#34;linuxbrew&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="n">persistent_volume_claim</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">claim_name</span> <span class="o">=</span> <span class="n">kubernetes_persistent_volume_claim</span><span class="p">.</span><span class="n">linuxbrew</span><span class="p">.</span><span class="n">metadata</span><span class="mf">.0</span><span class="p">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">        <span class="n">read_only</span>  <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
</details>

</p>
<p><em>Note: One quirk of this setup is that due to our environment using self signed certificate, we have to replace the external URL (the one used to access the envs) by the internal one (the coder service inside the ns) for our envs to start properly. In a more realistic scenario, trusted CA certs would be used instead.</em></p>
<p>To deploy this provider to our Coder instance, we&rsquo;ll need the <code>coder</code> cli, available <a href="https://github.com/coder/coder/releases">here</a>.
Depending on the exact setup (mainly due to self signed certificates), the login endpoint will vary, but the easiest is to port-forward the internal <code>coder</code> service and login through this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># in a tab</span>
</span></span><span class="line"><span class="cl">kubectl port-forward svc/coder 8080:80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># in another tab, then follow the login procedure</span>
</span></span><span class="line"><span class="cl">coder login http://127.0.0.1:8080
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># once logged in, in the same dir as `main.tf`, reply yes to questions</span>
</span></span><span class="line"><span class="cl">coder template create kube
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># You should preview the resources that will be created for each env:</span>
</span></span><span class="line"><span class="cl">┌──────────────────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│ Template Preview                                 │
</span></span><span class="line"><span class="cl">├──────────────────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ RESOURCE                                         │
</span></span><span class="line"><span class="cl">├──────────────────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ kubernetes_persistent_volume_claim.docker        │
</span></span><span class="line"><span class="cl">├──────────────────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ kubernetes_persistent_volume_claim.home          │
</span></span><span class="line"><span class="cl">├──────────────────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ kubernetes_persistent_volume_claim.linuxbrew     │
</span></span><span class="line"><span class="cl">├──────────────────────────────────────────────────┤
</span></span><span class="line"><span class="cl">│ kubernetes_pod.main                              │
</span></span><span class="line"><span class="cl">│ └─ main <span class="o">(</span>linux, amd64<span class="o">)</span>                           │
</span></span><span class="line"><span class="cl">└──────────────────────────────────────────────────┘
</span></span></code></pre></div><h2 id="accessing-our-environment">Accessing our environment<a hidden class="anchor" aria-hidden="true" href="#accessing-our-environment">#</a></h2>
<p>Now everything required to work directly into our cluster is deployed.
We can now create a Workspace based on the provider we defined earlier:
<img alt="workspace" loading="lazy" src="/coder-remote-env/workspace.png"></p>
<p>Wait for the pod to be created and the <code>code-server</code> button to become available.
Now we can work using a web browser from our thin &amp; light laptop (or even a Raspberry Pi) with the power of a cluster:</p>
<video class="video-shortcode" preload="auto" controls autoplay width="100%">
  <source src="/coder-remote-env/demo.mp4" type="video/mp4">
  There should have been a video here but your browser does not seem to support it.
</video>
<h2 id="disclaimer">Disclaimer<a hidden class="anchor" aria-hidden="true" href="#disclaimer">#</a></h2>
<p>This setup is loosely based on what is deployed and used daily at $job.
The main upsides are that :</p>
<ul>
<li>onboarding/updating/offboarding the environments are dead-easy,</li>
<li>laptops are running way cooler, batteries last longer and builds are way faster,</li>
<li>and testing has very little friction due to the fact that we are right inside the cluster.</li>
</ul>
<p>But there is some downsides:</p>
<ul>
<li>notably around security, our envs are running as privileged in the cluster (for dockerd), which might not be fine depending on the level of trust you want.
One possible fix would be to switch to a rootless docker/podman, but as of time of writing, there are too many quirks when deploying such solutions.</li>
<li>having the dev envs centralised means possibly a SPOF that could ruin everyone&rsquo;s day if something goes wrong with the platform or the cluster.</li>
<li>it might require a certain level of maturity around containers, mainly around how networking is affected by a remote setup.</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/remote/">Remote</a></li>
      <li><a href="/tags/k8s/">K8s</a></li>
      <li><a href="/tags/coder/">Coder</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="/posts/reset-password-with-docker/">
    <span class="title">« Prev</span>
    <br>
    <span>Reset a lost account password using docker</span>
  </a>
  <a class="next" href="/posts/translating-kubernetes/">
    <span class="title">Next »</span>
    <br>
    <span>Contributing to the k8s documentation</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="/">k0rventen&#39;s blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
